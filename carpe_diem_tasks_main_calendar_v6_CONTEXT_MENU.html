<!doctype html>
<html lang="el">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Carpe Diem</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b1020;
      --panel:#0f172a;   /* slate-900-ish */
      --panel2:#111c33;
      --border: rgba(255,255,255,.10);
      --border2: rgba(255,255,255,.14);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);
      --hover: rgba(255,255,255,.06);
      --focus: rgba(56,189,248,.55);
    }
    html, body { height: 100%; }
    body{
      margin:0;
      color: var(--text);
      background: var(--bg); /* minimalist: no heavy gradients */
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      font-size: 13px;
      line-height: 1.25;
      overflow:hidden;
    }

    /* Minimal panels (no heavy glass) */
    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02));
      border: 1px solid var(--border);
      border-radius: 14px;
    }
    .panel-strong{
      background: rgba(255,255,255,.03);
      border: 1px solid var(--border2);
      border-radius: 14px;
    }

    .btn{
      transition: background .15s ease, opacity .15s ease, transform .08s ease;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.02);
    }
    .btn:hover{ background: var(--hover); }
    .btn:active{ transform: translateY(1px); }
    .btn-ghost{
      border: 1px solid transparent;
      background: transparent;
    }
    .btn-ghost:hover{ background: var(--hover); border-color: var(--border); }

    /* Main Calendar modal (fixed center; no layout shift of calendar) */
    .modal-backdrop{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.55);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 9999;
    }
    .modal{
      position: relative;
      max-height: 90vh;
      overflow: auto;
    }

    .scrollbar::-webkit-scrollbar{ width: 10px; height:10px; }
    .scrollbar::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,.14);
      border-radius: 999px;
      border: 2px solid rgba(0,0,0,0);
      background-clip: padding-box;
    }
    .scrollbar::-webkit-scrollbar-track{ background: rgba(255,255,255,.04); border-radius: 999px; }

    /* Grid */
    .grid-wrap{ overflow: auto; max-height: calc(100vh - 186px); border-radius: 12px; }
    table{
      border-collapse: separate;
      border-spacing: 0;
      width: max-content;
      min-width: 100%;
    }
    th, td{
      border-right: 1px solid rgba(255,255,255,.08);
      border-bottom: 1px solid rgba(255,255,255,.08);
      padding: 6px 8px;
      vertical-align: middle;
      white-space: nowrap;
      width: max-content;
      font-size: 12px;
    }
    th{
      position: sticky;
      top: 0;
      z-index: 10;
      background: rgba(255,255,255,.035);
      backdrop-filter: none;
      text-align: left;
      font-weight: 800;
      cursor: pointer;
      user-select: none;
    }
    tr:hover td{ background: rgba(255,255,255,.02); }

    .rownum, .rownum-th{
      position: sticky;
      left: 0;
      z-index: 9;
      background: rgba(255,255,255,.035);
      user-select: none;
    }
    .rownum{
      cursor: pointer;
      font-variant-numeric: tabular-nums;
      color: rgba(255,255,255,.72);
    }
    .rownum.selected{
      outline: 2px solid rgba(56,189,248,.35);
      outline-offset: -2px;
      background: rgba(56,189,248,.06);
    }
    th.selected{
      outline: 2px solid rgba(56,189,248,.35);
      outline-offset: -2px;
      background: rgba(56,189,248,.06);
    }

    input.cell.num{ min-width: 0; width: 100%; max-width: 140px; text-align: right; }

    input.cell{
      width: 100%;
      min-width: 0px;
      max-width: 420px;
      background: rgba(255,255,255,.02);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 8px;
      padding: 5px 8px;
      color: rgba(255,255,255,.92);
      outline: none;
      font-size: 12px;
    }
    input.cell:focus{ border-color: var(--focus); }
    .checkbox{ width: 14px; height: 14px; accent-color: rgb(56,189,248); cursor: pointer; }

    .pill{
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 999px;
      padding: 4px 8px;
      font-size: 11px;
      color: rgba(255,255,255,.72);
    }
    .muted{ color: var(--muted); }

    /* Subtle dividers */
    .divider{ border-top: 1px solid rgba(255,255,255,.08); }
  
/* === STRONG NEON BLUE MODAL (V2) === */
.modal-overlay{
  position: fixed;
  inset: 0;
  background: #000814;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 99999;
}

.modal{
  background: #020617;
  border: 3px solid #00e5ff;
  box-shadow: none;
  border-radius: 18px;
  padding: 22px;
  width: 1100px; max-width: 95vw;
  max-height: 85vh;
  overflow-y: auto;
  color: #e6faff;
}

.modal h2{
  font-size: 18px;
  font-weight: 900;
  margin-bottom: 16px;
  color: #00e5ff;
  text-shadow:
    0 0 6px #00e5ff,
    0 0 14px #00e5ff;
}

.modal label{
  font-size: 12px;
  font-weight: 700;
  color: #9ff3ff;
  margin-bottom: 4px;
  display: block;
}

.modal input[type="text"]{
  width: 100%;
  background: #000814;
  border: 2px solid #00e5ff;
  border-radius: 10px;
  padding: 7px 10px;
  color: #e6faff;
  font-size: 13px;
  box-shadow:
    0 0 8px rgba(0,229,255,.7),
    inset 0 0 6px rgba(0,229,255,.4);
}

.modal input[type="checkbox"]{
  width: 18px;
  height: 18px;
  accent-color: #00e5ff;
  box-shadow: 0 0 6px #00e5ff;
}

.modal-footer{
  display: flex;
  justify-content: flex-end;
  gap: 12px;
  margin-top: 20px;
}

.modal-btn{
  padding: 8px 18px;
  border-radius: 12px;
  font-size: 13px;
  font-weight: 800;
  border: 2px solid #00e5ff;
  background: #000814;
  color: #00e5ff;
  cursor: pointer;
  box-shadow: none;
}

.modal-btn:hover{
  box-shadow: none;
}


/* === NEON MODAL (CENTERED, WHITE TEXT) === */
.modal-overlay{
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 99999;
}

.modal{
  background: #020617;
  border: 3px solid #00e5ff;
  box-shadow: none;
  border-radius: 18px;
  padding: 22px;
  width: 1100px; max-width: 95vw;
  max-height: 80vh;
  overflow-y: auto;
  color: #ffffff;
}

/* force ALL text white inside modal */
.modal, .modal *{ color: #ffffff !important; }

.modal h2{
  font-size: 18px;
  font-weight: 900;
  margin-bottom: 16px;
  text-shadow: 0 0 8px #00e5ff;
}

.modal input[type="text"]{
  width: 100%;
  background: #000814;
  border: 2px solid #00e5ff;
  border-radius: 10px;
  padding: 7px 10px;
  font-size: 13px;
}

.modal input[type="checkbox"]{
  width: 18px;
  height: 18px;
  accent-color: #00e5ff;
}

.modal-footer{
  display: flex;
  justify-content: flex-end;
  gap: 12px;
  margin-top: 20px;
}

.modal-btn{
  padding: 8px 18px;
  border-radius: 12px;
  font-size: 13px;
  font-weight: 800;
  border: 2px solid #00e5ff;
  background: #000814;
  cursor: pointer;
  box-shadow: none;
}

.modal-btn:hover{ box-shadow: none; }


/* modal sync hint */
.modal-btn{ white-space: nowrap; }

/* === HIDE SCROLLBAR INSIDE MODAL (KEEP WHEEL SCROLL) === */
.modal{
  scrollbar-width: none;          /* Firefox */
  -ms-overflow-style: none;       /* IE 10+ */
}
.modal::-webkit-scrollbar{
  width: 0px;
  height: 0px;
  display: none;                  /* Chrome, Safari */
}


/* Hide number input spinners (no arrows) */
input[type=number]::-webkit-outer-spin-button,
input[type=number]::-webkit-inner-spin-button{
  -webkit-appearance: none;
  margin: 0;
}
input[type=number]{ -moz-appearance: textfield; }


/* === Column resize (Excel-like) === */
table{ table-layout: fixed; }
th{ position: sticky; } /* already sticky; keep */
th.resizable{ position: sticky; }
.col-resizer{
  position:absolute;
  right:-3px;
  top:0;
  width:6px;
  height:100%;
  cursor: col-resize;
  z-index: 60;
}
.col-resizer:hover{
  background: rgba(0, 255, 255, 0.22);
}


/* Ultra-compact Board column */
td[data-colkey="board"] input.cell,
th[data-colkey="board"] {
  padding-left: 4px !important;
  padding-right: 4px !important;
  text-align: center;
}


/* === ULTRA DENSE GRID (space saving) === */
table { font-size: 11px; }
th { padding: 4px 6px !important; }
td { padding: 2px 4px !important; }

input.cell{
  height: 24px !important;
  padding: 2px 4px !important;
  border-radius: 6px !important;
  font-size: 11px !important;
  min-width: 0 !important;
}

input.cell.num{
  text-align: center;
}


/* ===========================
   Transfers (scoped styles)
   =========================== */
.transfers-wrap{ overflow:auto; max-height: calc(100vh - 206px); border-radius: 12px; }
.t-chip{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding: 3px 8px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.03);
  font-size: 11px;
  line-height: 1.15;
  margin: 2px 4px 2px 0;
  cursor: default;
  user-select:none;
}
.t-chip:hover{ background: rgba(255,255,255,.05); }
.t-badge{
  font-size: 10px;
  padding: 2px 6px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.05);
}
.t-badge.private{
  border-color: rgba(56,189,248,.45);
  background: rgba(56,189,248,.10);
}
.t-section-row td{
  background: rgba(255,255,255,.03);
  font-weight: 800;
}
.t-area-total{
  font-weight: 700;
  color: rgba(255,255,255,.72);
}
.t-status{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding: 6px 10px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.02);
  font-size: 11px;
  color: rgba(255,255,255,.80);
}

/* Read-only modal for Private chip */
.tmodal-overlay{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.65);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index: 99998;
}
.tmodal{
  width: 720px;
  max-width: 95vw;
  max-height: 82vh;
  overflow:auto;
  background: rgba(15, 23, 42, .92);
  border: 1px solid rgba(255,255,255,.14);
  border-radius: 16px;
  padding: 16px;
}
.tmodal h3{
  font-size: 14px;
  font-weight: 900;
  margin: 0 0 10px 0;
}
.tmodal .kv{
  display:grid;
  grid-template-columns: 140px 1fr;
  gap: 8px 12px;
  font-size: 12px;
}
.tmodal .k{ color: rgba(255,255,255,.65); font-weight: 700; }
.tmodal .v{ color: rgba(255,255,255,.92); font-weight: 700; }


/* === FIX: Solid background for sticky Transfers column === */
#viewTransfers th.rownum-th,
#viewTransfers td.rownum {
  background: #0f172a !important;
  backdrop-filter: none !important;
}
#viewTransfers .t-section-row td.rownum {
  background: #0b1020 !important;
}
#viewTransfers td.rownum,
#viewTransfers th.rownum-th {
  box-shadow: 4px 0 0 rgba(0,0,0,0.35);
}


/* === Transfers: show reservations vertically (stack chips) === */
#viewTransfers .transfers-wrap .t-chip{
  display: flex;          /* override inline-flex */
  width: 100%;
  white-space: normal;    /* allow wrap if needed */
}


/* === Transfers: clearer day separators + maximum space economy + no gaps === */
#viewTransfers .transfers-wrap table{
  border-spacing: 0 !important;
  border-collapse: separate !important;
}
#viewTransfers .transfers-wrap th,
#viewTransfers .transfers-wrap td{
  border-right: 1px solid rgba(255,255,255,.18) !important;
  border-bottom: 1px solid rgba(255,255,255,.14) !important;
}
#viewTransfers .transfers-wrap th{
  border-top: 1px solid rgba(255,255,255,.18) !important;
}
#viewTransfers .transfers-wrap tr > *:first-child{
  border-left: 1px solid rgba(255,255,255,.18) !important;
}
#viewTransfers .transfers-wrap th{
  padding: 3px 6px !important;
  font-size: 11px !important;
  line-height: 1.05 !important;
}
#viewTransfers .transfers-wrap th .muted{
  font-size: 9px !important;
  margin-top: 2px !important;
}
#viewTransfers .transfers-wrap td{
  padding: 0 !important;              /* no gaps */
  vertical-align: top !important;
}
#viewTransfers .transfers-wrap .t-chip{
  display: flex;
  width: 100%;
  white-space: normal;
  padding: 2px 6px !important;
  margin: 0 !important;
  border-radius: 0 !important;        /* no gaps between chips */
  font-size: 10px !important;
  gap: 5px !important;
}
#viewTransfers .transfers-wrap .pill{
  padding: 2px 6px !important;
  font-size: 10px !important;
}
#viewTransfers .transfers-wrap .t-badge{
  padding: 1px 5px !important;
  font-size: 9px !important;
}
#viewTransfers td.rownum, 
#viewTransfers th.rownum-th{
  min-width: 210px !important;
  max-width: 210px !important;
  padding: 4px 6px !important;
}
#viewTransfers .t-section-row td{
  padding-top: 4px !important;
  padding-bottom: 4px !important;
}
/* keep empty cells visible */
#viewTransfers .transfers-wrap td:empty::after{
  content: "";
  display: block;
  min-height: 14px;
}


/* === FIX: keep table cells as table-cells (no flex on td) to avoid huge row heights === */
#viewTransfers .transfers-wrap tbody td:not(.rownum) .t-cell{
  display: flex;
  flex-direction: column;
  gap: 0;
  align-items: stretch;
  min-height: 14px; /* keeps grid visible even if empty */
}

/* === Transfer Operator Pills === */
.op-pill{
  font-weight: 800;
  padding: 2px 8px;
  border-radius: 999px;
  font-size: 10px;
  border: 1px solid transparent;
  white-space: nowrap;
}
.op-grecos{background: rgba(56,189,248,.20);border-color: rgba(56,189,248,.65);color:#7dd3fc;}
.op-sunweb{background: rgba(236,72,153,.20);border-color: rgba(236,72,153,.65);color:#f9a8d4;}
.op-bluestyle{background: rgba(37,99,235,.22);border-color: rgba(37,99,235,.7);color:#93c5fd;}
.op-satur{background: rgba(239,68,68,.20);border-color: rgba(239,68,68,.7);color:#fca5a5;}
.op-palma{background: rgba(249,115,22,.22);border-color: rgba(249,115,22,.7);color:#fdba74;}


/* === Tasks (Aggregate): color stripe per operator === */
.task-op{ border-left-width: 4px !important; border-left-style: solid !important; }
.task-op.op-grecos{ border-left-color: rgba(56,189,248,.95) !important; }
.task-op.op-sunweb{ border-left-color: rgba(236,72,153,.95) !important; }
.task-op.op-bluestyle{ border-left-color: rgba(37,99,235,.95) !important; }
.task-op.op-satur{ border-left-color: rgba(239,68,68,.95) !important; }
.task-op.op-palma{ border-left-color: rgba(249,115,22,.95) !important; }





/* Dark theme date input to match toolbar buttons */
.dark-date-input{
  background: linear-gradient(180deg,#1c2230,#141a26);
  color:#ffffff;
  border:1px solid rgba(255,255,255,.15);
  border-radius:10px;
  padding:8px 12px;
  height:36px;
  font-size:13px;
  outline:none;
}
.dark-date-input:hover{border-color:rgba(255,255,255,.35);}
.dark-date-input:focus{
  border-color:#4f8cff;
  box-shadow:0 0 0 1px rgba(79,140,255,.4);
}
/* Calendar icon */
.dark-date-input::-webkit-calendar-picker-indicator{
  filter:invert(1);
  opacity:.8;
  cursor:pointer;
}

/* === Tasks: Ï€Î¹Î¿ ÏƒÏ„ÎµÎ½Î® ÏƒÏ„Î®Î»Î· Î·Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±Ï‚ === */
.tasks-table th.rownum-th,
.tasks-table td.rownum {
  min-width: 64px;
  max-width: 64px;
  width: 64px;
  padding: 2px 4px !important;
  font-size: 10px;
  line-height: 1.05;
  text-align: center;
}
.tasks-table td.rownum .font-extrabold {
  font-size: 10px;
}
.tasks-table td.rownum .muted {
  font-size: 9px;
}


/* === Tasks: auto-resize task cells === */
.task-cell{
  resize: none;
  overflow: hidden;
  white-space: pre-wrap;
  word-break: break-word;
  min-height: 24px;
  height: auto;
  line-height: 1.25;
}


/* === Tasks: allow Task column to expand (override global table-layout: fixed) === */
.tasks-table{ table-layout: auto !important; }
.tasks-table td, .tasks-table th{ width: auto; }

/* Make task text always visible + consistent dark theme */
.tasks-table .task-cell{
  box-sizing: border-box;
  background: rgba(255,255,255,.02) !important;
  color: rgba(255,255,255,.92) !important;
  border: 1px solid rgba(255,255,255,.10) !important;
  border-radius: 8px !important;
  padding: 2px 4px !important;
  font-size: 11px !important;
  line-height: 1.25 !important;

  resize: none;
  overflow: hidden; /* height autosize */
  min-height: 24px;
  height: 24px;
  width: 100%;      /* start full width of column */
}

/* keep the Task column from becoming too small */
.tasks-table th:nth-child(4),
.tasks-table td:nth-child(4){
  min-width: 260px;
}


/* === Tasks: smaller checkbox column (optical) === */
.tasks-table input[type="checkbox"]{
  width: 12px !important;
  height: 12px !important;
  transform: scale(0.85);
}

.tasks-table th:nth-child(3),
.tasks-table td:nth-child(3){
  width: 32px !important;
  min-width: 32px !important;
  max-width: 32px !important;
  text-align: center;
  padding-left: 4px !important;
  padding-right: 4px !important;
}


/* === Tasks (Excel-like): stable columns + auto-height only === */
.tasks-table{ table-layout: fixed !important; width: 100%; }
.tasks-table th, .tasks-table td{ width: auto; }

/* Task column: give it a stable, wider width */
.tasks-table th:nth-child(4),
.tasks-table td:nth-child(4){
  width: 520px !important;
  min-width: 520px !important;
  max-width: 520px !important;
}

/* Task cell: fill the column width, wrap text, auto-height */
.tasks-table .task-cell{
  width: 100% !important;
  box-sizing: border-box;
  resize: none;
  overflow: hidden;              /* auto-height without scrollbar */
  white-space: pre-wrap;
  word-break: break-word;
  background: rgba(255,255,255,.02) !important;
  color: rgba(255,255,255,.92) !important;
  border: 1px solid rgba(255,255,255,.10) !important;
  border-radius: 8px !important;
  padding: 2px 6px !important;
  font-size: 11px !important;
  line-height: 1.25 !important;
  min-height: 24px;
  height: 24px;
}


/* === Tasks (Excel-like v2): fixed small cols, Task takes the rest (no huge gap) === */
.tasks-table{ table-layout: fixed !important; width: 100% !important; }

/* Column widths: Day / â„– / âœ“ fixed, Task = remaining space */
.tasks-table th:nth-child(1),
.tasks-table td:nth-child(1){
  width: 64px !important;
  min-width: 64px !important;
  max-width: 64px !important;
}

.tasks-table th:nth-child(2),
.tasks-table td:nth-child(2){
  width: 44px !important;
  min-width: 44px !important;
  max-width: 44px !important;
  text-align: center !important;
}

.tasks-table th:nth-child(3),
.tasks-table td:nth-child(3){
  width: 32px !important;
  min-width: 32px !important;
  max-width: 32px !important;
  text-align: center !important;
}

.tasks-table th:nth-child(4),
.tasks-table td:nth-child(4){
  width: auto !important;          /* take remaining */
  min-width: 320px !important;
}

/* Task cell fills the column; auto-height only */
.tasks-table .task-cell{
  width: 100% !important;
}


/* === Task (Soon) ÏƒÏ…Î³ÎºÎµÎ½Ï„ÏÏ‰Ï„Î¹ÎºÏŒ: 5 ÏƒÏ„Î®Î»ÎµÏ‚ (Operator + Task) === */
#viewTaskSoon .tasks-table th:nth-child(4),
#viewTaskSoon .tasks-table td:nth-child(4){
  width: 120px !important;
  min-width: 120px !important;
  max-width: 120px !important;
}
#viewTaskSoon .tasks-table th:nth-child(5),
#viewTaskSoon .tasks-table td:nth-child(5){
  width: auto !important;
}



/* Modal select styling */
.modal select.cell{
  width: 100%;
  background: #000814;
  border: 2px solid #00e5ff;
  border-radius: 10px;
  padding: 7px 10px;
  font-size: 13px;
}

/* === FIX: textarea visibility inside modal === */
.modal textarea{
  background: #000814 !important;
  color: #ffffff !important;
  border: 2px solid #00e5ff;
}


/* === Main Calendar: flag / done / color UI === */
.mc-chip{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:2px 8px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.04);
  font-size:11px;
  line-height:1;
}
.mc-dot{
  width:10px;height:10px;border-radius:999px;
  border:1px solid rgba(255,255,255,.25);
  display:inline-block;
}
.mc-palette{
  display:grid;
  grid-template-columns: repeat(10, 1fr);
  gap:8px;
}
.mc-color-btn{
  width:22px;height:22px;border-radius:8px;
  border:1px solid rgba(255,255,255,.22);
  cursor:pointer;
}
.mc-color-btn:focus{ outline: 2px solid rgba(56,189,248,.55); outline-offset: 2px; }


/* === FIX: Color palette positioning (no overlap with notes) === */
.mc-palette-wrap{
  position: relative;
  margin-bottom: 8px;
}
.mc-palette-panel{
  position: relative;
  margin-top: 6px;
}


/* === Main Calendar: done capsule style === */
.mc-item-done{
  background: rgba(34,197,94,.22) !important;   /* green */
  border-color: rgba(34,197,94,.55) !important;
}
.mc-item-done:hover{
  background: rgba(34,197,94,.26) !important;
}


/* === Context Menu for calendar items === */
.mc-context{
  position: fixed;
  z-index: 100000;
  background: #020617;
  border: 2px solid #00e5ff;
  border-radius: 10px;
  min-width: 160px;
  box-shadow: 0 0 12px rgba(0,229,255,.35);
}
.mc-context button{
  width: 100%;
  text-align: left;
  padding: 8px 12px;
  font-size: 12px;
  background: transparent;
  border: none;
  color: #ffffff;
  cursor: pointer;
}
.mc-context button:hover{
  background: rgba(0,229,255,.15);
}

</style>


  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" crossorigin="anonymous"></script>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>

<body>
  <div id="root"></div>

  <script type="text/babel">
    const TOUR_OPERATORS = ["Grecos", "Sunweb", "BlueStyle", "Satur", "Palma"];

    // ===== Global helpers (shared across Hotels + Transfers) =====
    const sanitizeAccommodation = (value) => {
      return (value || "")
        .replace(/\b(appartementen|apparthotel)\b/gi, "")
        .replace(/\s*\([^)]*\)\s*/g, " ")
        .replace(/\s+/g, " ")
        .trim();
    };

    const operatorClass = (op) => {
  const v = (op || "").toLowerCase().trim();
  if (v.startsWith("grec")) return "op-grecos";
  if (v.startsWith("sun")) return "op-sunweb";
  if (v.startsWith("blue")) return "op-bluestyle";
  if (v.startsWith("satur")) return "op-satur";
  if (v.startsWith("palm")) return "op-palma";
  return "";
};



    const DEFAULT_COLUMNS = [
      { key: "aa", label: "Î‘/Î‘", type: "auto" },

      { key: "accomodation", label: "Accomodation", type: "text" },
      { key: "board", label: "Board", type: "text" },
      { key: "stars", label: "Stars", type: "text" },
            { key: "city", label: "City", type: "text" },
      { key: "email", label: "Email", type: "text" },
      { key: "phone", label: "Phone", type: "text" },

      { key: "commitment", label: "Commitment", type: "check" },
      { key: "allotment", label: "Allotment", type: "check" },
      { key: "pool", label: "Pool", type: "check" },
      { key: "signed", label: "Signed", type: "check" },

      { key: "hotel_total_beds", label: "Total Hotel's Beds", type: "text" },
    ];

// ===== Room Table (mini excel) defaults =====
const ROOM_TABLE_DEFAULT_COLS = [
  { key: "room_types", label: "Room types" },
  { key: "allocation", label: "Allocation" },
  { key: "min_pax", label: "Min Pax" },
  { key: "max_pax", label: "Max Pax" },
  { key: "total_min_beds", label: "Total min beds" },
  { key: "total_max_beds", label: "Total max beds" },
];

const makeRoomTable = (rowsCount = 10) => {
  const columns = [...ROOM_TABLE_DEFAULT_COLS];
  const rows = Array.from({ length: rowsCount }, () => {
    const r = {};
    columns.forEach(c => (r[c.key] = ""));
    return r;
  });
  return { columns, rows };
};


    const storageKey = (op) => `carpe_diem__${op}__hotels_v1`;
    const transfersStorageKey = (op) => `carpe_diem__${op}__transfers_v1`;
    const transfersStartKey = (op) => `carpe_diem__${op}__transfers_start_v1`;

    const emptyRow = (cols) => {
      const r = {};
      cols.forEach(c => {
        if (c.type === "check") r[c.key] = false;
        else if (c.type === "auto") r[c.key] = null;
        else r[c.key] = "";
      });
      return r;
    };

    function IconChevron({ open }) {
      return <span className="muted select-none">{open ? "â–¾" : "â–¸"}</span>;
    }

    

    // ===========================
    // Main Calendar (Monthly) â€” Î±Î½ÎµÎ¾Î¬ÏÏ„Î·Ï„Î¿ Î±Ï€ÏŒ Tour Operators
    // ===========================
    function MainCalendar(){
      const STORAGE_KEY = "carpe_main_calendar_entries_v1";


      const MC_COLORS = ["#00e5ff","#60a5fa","#a78bfa","#f472b6","#fb7185","#f97316","#facc15","#34d399","#22c55e","#f1f5f9"];
      const IMPORTANCE = [
        { key:"none", label:"â€”" },
        { key:"low", label:"Î§Î±Î¼Î·Î»Î®" },
        { key:"normal", label:"ÎšÎ±Î½Î¿Î½Î¹ÎºÎ®" },
        { key:"high", label:"Î¥ÏˆÎ·Î»Î®" },
      ];
      const pad = (n) => String(n).padStart(2,"0");
      const toISO = (d) => {
        const x = new Date(d);
        x.setHours(0,0,0,0);
        return `${x.getFullYear()}-${pad(x.getMonth()+1)}-${pad(x.getDate())}`;
      };
      const startOfMonth = (d) => new Date(d.getFullYear(), d.getMonth(), 1);
      const endOfMonth = (d) => new Date(d.getFullYear(), d.getMonth()+1, 0);
      const addDays = (d, n) => { const x=new Date(d); x.setDate(x.getDate()+n); return x; };

      const [monthDate, setMonthDate] = React.useState(() => {
        const now = new Date();
        return new Date(now.getFullYear(), now.getMonth(), 1);
      });

      const [itemsByDate, setItemsByDate] = React.useState(() => {
        try{
          const raw = localStorage.getItem(STORAGE_KEY);
          const parsed = raw ? JSON.parse(raw) : {};
          return (parsed && typeof parsed === "object") ? parsed : {};
        }catch{ return {}; }
      });

      React.useEffect(() => {
        try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(itemsByDate)); }catch{}
      }, [itemsByDate]);

      const [modalOpen, setModalOpen] = React.useState(false);
      const [form, setForm] = React.useState({ subject:"", dateISO: toISO(new Date()), time:"", name:"", phone:"", notes:"", flag:true, importance:"normal", done:false, color: MC_COLORS[0] });

      const [colorOpen, setColorOpen] = React.useState(false);
      const [editId, setEditId] = React.useState(null);
      const [editFromDate, setEditFromDate] = React.useState(null);
      const [ctx, setCtx] = React.useState(null); // {x,y,iso,it}

      const openForDate = (iso) => {
        setEditId(null);
        setEditFromDate(null);
        setForm({ subject:"", dateISO: iso, time:"", name:"", phone:"", notes:"", flag:true, importance:"normal", done:false, color: MC_COLORS[0] });
        setColorOpen(false);
        setModalOpen(true);
      };
      const openForItem = (iso, item) => {
        setEditId(item?.id || null);
        setEditFromDate(iso);
        setForm({
          subject: item?.subject || "",
          dateISO: item?.dateISO || iso,
          time: item?.time || "",
          name: item?.name || "",
          phone: item?.phone || "",
          notes: item?.notes || "",
          flag: (item?.flag !== undefined) ? !!item.flag : ((item?.importance || "none") !== "none"),
          importance: item?.importance || "normal",
          done: !!item?.done,
          color: item?.color || MC_COLORS[0],
        });
        setColorOpen(false);
        setModalOpen(true);
      };



      const saveItem = () => {
        const subject = (form.subject||"").trim();
        if (!subject) { alert("Î£Ï…Î¼Ï€Î»Î®ÏÏ‰ÏƒÎµ Î˜Î­Î¼Î±."); return; }
        const iso = form.dateISO;

        const normalizedImportance = form.flag ? (form.importance || "normal") : "none";

        const item = {
          id: editId || `mc_${Date.now()}_${Math.random().toString(16).slice(2)}`,
          subject,
          dateISO: iso,
          time: (form.time||"").trim(),
          name: (form.name||"").trim(),
          phone: (form.phone||"").trim(),
          notes: (form.notes||"").trim(),
          flag: !!form.flag,
          importance: normalizedImportance,
          done: !!form.done,
          color: (form.color || MC_COLORS[0]),
          createdAt: new Date().toISOString(),
        };

        setItemsByDate(prev => {
          const next = { ...(prev||{}) };

          // If editing and date changed, remove from old date bucket first
          if (editId && editFromDate){
            const fromArr = Array.isArray(next[editFromDate]) ? [...next[editFromDate]] : [];
            const filtered = fromArr.filter(x => x?.id !== editId);
            if (filtered.length) next[editFromDate] = filtered;
            else delete next[editFromDate];
          }

          const arr = Array.isArray(next[iso]) ? [...next[iso]] : [];
          const idx = arr.findIndex(x => x?.id === item.id);
          if (idx >= 0) arr[idx] = item;
          else arr.push(item);
          next[iso] = arr;
          return next;
        });

        setModalOpen(false);
        setEditId(null);
        setEditFromDate(null);
      };

      const deleteItem = (iso, id) => {
        setItemsByDate(prev => {
          const next = { ...(prev||{}) };
          const arr = Array.isArray(next[iso]) ? next[iso].filter(x => x.id !== id) : [];
          if (!arr.length) delete next[iso];
          else next[iso] = arr;
          return next;
        });
      };

      const toggleItemDone = (iso, id) => {
        setItemsByDate(prev => {
          const next = { ...(prev||{}) };
          const arr = Array.isArray(next[iso]) ? [...next[iso]] : [];
          const idx = arr.findIndex(x => x?.id === id);
          if (idx < 0) return next;
          const cur = arr[idx] || {};
          arr[idx] = { ...cur, done: !cur.done };
          next[iso] = arr;
          return next;
        });
      };

      const onItemContext = (e, iso, it) => {
        e.preventDefault();
        e.stopPropagation();
        setCtx({ x: e.clientX, y: e.clientY, iso, it });
      };


      // Build month grid (6 weeks)
      const first = startOfMonth(monthDate);
      const last = endOfMonth(monthDate);
      const startWeekday = (first.getDay() + 6) % 7; // Monday=0
      const gridStart = addDays(first, -startWeekday);
      const days = Array.from({length: 42}, (_,i) => addDays(gridStart, i));

      const monthLabel = monthDate.toLocaleDateString("el-GR", { month:"long", year:"numeric" });

      const isSameMonth = (d) => d.getMonth() === monthDate.getMonth() && d.getFullYear() === monthDate.getFullYear();

      return (
        <div className="h-full flex flex-col">
          <div className="panel p-3 mb-3 flex items-center justify-between">
            <div className="flex items-center gap-2">
              <button className="btn rounded-xl px-3 py-1.5 text-[12px]" onClick={() => setMonthDate(d => new Date(d.getFullYear(), d.getMonth()-1, 1))}>â†</button>
              <button className="btn rounded-xl px-3 py-1.5 text-[12px]" onClick={() => setMonthDate(() => { const n=new Date(); return new Date(n.getFullYear(), n.getMonth(), 1); })}>Î£Î®Î¼ÎµÏÎ±</button>
              <button className="btn rounded-xl px-3 py-1.5 text-[12px]" onClick={() => setMonthDate(d => new Date(d.getFullYear(), d.getMonth()+1, 1))}>â†’</button>
              <div className="text-[14px] font-extrabold capitalize ml-2">{monthLabel}</div>
            </div>
            <div className="text-[11px] muted">ÎšÎ»Î¯ÎºÎ±ÏÎµ Î¼Î¹Î± Î·Î¼Î­ÏÎ± Î³Î¹Î± Î½Î­Î± ÏƒÎ·Î¼ÎµÎ¯Ï‰ÏƒÎ·</div>
          </div>

          <div className="grid grid-cols-7 gap-2">
            {["Î”ÎµÏ…","Î¤ÏÎ¹","Î¤ÎµÏ„","Î ÎµÎ¼","Î Î±Ï","Î£Î±Î²","ÎšÏ…Ï"].map(w => (
              <div key={w} className="text-[11px] muted px-2">{w}</div>
            ))}
          </div>

          <div className="mt-2 grid grid-cols-7 gap-2 flex-1 overflow-auto scrollbar pr-1">
            {days.map((d) => {
              const iso = toISO(d);
              const items = itemsByDate[iso] || [];
              const dayColor = (items[items.length-1]?.color) || null;
              const anyHigh = items.some(x => x?.importance === "high");
              const anyFlag = items.some(x => x?.importance && x.importance !== "none");
              const allDone = items.length ? items.every(x => !!x?.done) : false;

              const faded = !isSameMonth(d);
              const isToday = iso === toISO(new Date());
              return (
                <button
                  key={iso}
                  className={"panel text-left p-2 min-h-[110px] flex flex-col gap-1 " + (faded ? "opacity-60" : "") + (isToday ? " ring-2 ring-sky-400/40" : "")}
                  onClick={() => { setCtx(null); openForDate(iso); }}
                  title="Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· ÏƒÎ·Î¼ÎµÎ¯Ï‰ÏƒÎ·Ï‚"
                  style={dayColor ? { borderColor: dayColor, boxShadow: `0 0 0 1px ${dayColor}55 inset` } : {}}
                >
                  <div className="flex items-center justify-between">
                    <div className="text-[12px] font-extrabold tabular-nums">{d.getDate()}</div>
                    <div className="flex items-center gap-1 text-[10px] muted tabular-nums">
                      <span>{iso}</span>
                      {anyFlag ? <span title={anyHigh ? "Î¥ÏˆÎ·Î»Î® ÏƒÎ·Î¼Î±Î½Ï„Î¹ÎºÏŒÏ„Î·Ï„Î±" : "Î£Î·Î¼Î±Î¯Î±"} className="opacity-90">ğŸš©</span> : null}
                      {allDone ? <span title="ÎˆÏ„Î¿Î¹Î¼Î±" className="opacity-90">âœ…</span> : null}
                    </div>
                  </div>

                  <div className="flex-1 overflow-auto scrollbar pr-1">
                    {items.slice(0, 6).map(it => (
                      <div key={it.id} className={"flex items-center justify-between gap-2 border rounded-lg px-2 py-1 mt-1 " + (it.done ? "mc-item-done" : "bg-white/5 border-white/10")} onDoubleClick={(e)=>{ e.stopPropagation(); openForItem(iso, it); }} onContextMenu={(e)=>onItemContext(e, iso, it)} title="Î”Î¹Ï€Î»ÏŒ ÎºÎ»Î¹Îº Î³Î¹Î± ÎµÏ€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± â€¢ Î”ÎµÎ¾Î¯ ÎºÎ»Î¹Îº: Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±">
                        <span className="mc-dot" style={{background: (it.color || "transparent")}} title="Î§ÏÏÎ¼Î±"></span>
                        <div className="text-[11px] font-semibold truncate" title={it.subject}>
                          {it.subject}{it.time ? <span className="muted font-semibold"> Â· {it.time}</span> : null}
                          {it.importance && it.importance !== "none" ? <span className="ml-1" title="Î£Î·Î¼Î±Î¯Î±">ğŸš©</span> : null}
                          {it.done ? <span className="ml-1" title="ÎˆÏ„Î¿Î¹Î¼Î¿">âœ…</span> : null}
                        </div>
                        <div className="flex items-center gap-1">
                        <button
                          className="btn btn-ghost rounded-lg px-2 py-0.5 text-[11px]"
                          title={it.done ? "ÎœÎ· Î­Ï„Î¿Î¹Î¼Î¿" : "ÎˆÏ„Î¿Î¹Î¼Î¿"}
                          onClick={(e) => { e.stopPropagation(); toggleItemDone(iso, it.id); }}
                        >
                          âœ“
                        </button>
                        <button
                          className="btn btn-ghost rounded-lg px-2 py-0.5 text-[11px]"
                          title="Î”Î¹Î±Î³ÏÎ±Ï†Î®"
                          onClick={(e) => { e.stopPropagation(); if(confirm("Î”Î¹Î±Î³ÏÎ±Ï†Î® ÏƒÎ·Î¼ÎµÎ¯Ï‰ÏƒÎ·Ï‚;")) deleteItem(iso, it.id); }}
                        >
                          âœ•
                        </button>
                      </div>
                      </div>
                    ))}
                    {items.length > 6 && (
                      <div className="text-[11px] muted mt-2">+{items.length-6} Î±ÎºÏŒÎ¼Î·â€¦</div>
                    )}
                  </div>
                </button>
              );
            })}
          </div>

          
          {ctx && (
            <div
              className="mc-context"
              style={{ top: ctx.y, left: ctx.x }}
              onMouseLeave={()=>setCtx(null)}
            >
              <button onClick={()=>{ setCtx(null); openForItem(ctx.iso, ctx.it); }}>
                âœï¸ Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±
              </button>
              <button onClick={()=>{ setCtx(null); setForm(f=>({...f, color: ctx.it.color || MC_COLORS[0]})); setColorOpen(true); setModalOpen(true); setEditId(ctx.it.id); setEditFromDate(ctx.iso); }}>
                ğŸ¨ Î§ÏÏÎ¼Î±
              </button>
              <button onClick={()=>{
                setCtx(null);
                if(confirm("Î”Î¹Î±Î³ÏÎ±Ï†Î® ÏƒÎ·Î¼ÎµÎ¯Ï‰ÏƒÎ·Ï‚;")) deleteItem(ctx.iso, ctx.it.id);
              }}>
                ğŸ—‘ Î”Î¹Î±Î³ÏÎ±Ï†Î®
              </button>
            </div>
          )}

{modalOpen && (
            <div className="modal-backdrop" onMouseDown={(e)=>{ if(e.target===e.currentTarget) setModalOpen(false); }}>
              <div className="modal panel-strong p-4 w-[520px] max-w-[92vw]">
                <div className="flex items-center justify-between mb-3">
                  <div className="text-[14px] font-extrabold">ÎÎ­Î± Î£Î·Î¼ÎµÎ¯Ï‰ÏƒÎ·</div>
                  <button className="btn btn-ghost rounded-xl px-3 py-1.5 text-[12px]" onClick={()=>setModalOpen(false)}>ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿</button>
                </div>

                <div className="grid grid-cols-2 gap-2">
                  <label className="text-[11px] muted">
                    Î˜Î­Î¼Î±
                    <input className="cell mt-1 w-full" value={form.subject} onChange={(e)=>setForm(f=>({...f, subject:e.target.value}))} />
                  </label>

                  <label className="text-[11px] muted">
                    Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±
                    <input className="cell dark-date-input mt-1 w-full" type="date" value={form.dateISO} onChange={(e)=>setForm(f=>({...f, dateISO:e.target.value}))} />
                  </label>

                  <label className="text-[11px] muted">
                    ÎÏÎ±
                    <input className="cell mt-1 w-full" type="time" value={form.time} onChange={(e)=>setForm(f=>({...f, time:e.target.value}))} />
                  </label>

                  <label className="text-[11px] muted">
                    ÎŒÎ½Î¿Î¼Î±
                    <input className="cell mt-1 w-full" value={form.name} onChange={(e)=>setForm(f=>({...f, name:e.target.value}))} />
                  </label>

                  <label className="text-[11px] muted">
                    Î¤Î·Î»Î­Ï†Ï‰Î½Î¿
                    <input className="cell mt-1 w-full" value={form.phone} onChange={(e)=>setForm(f=>({...f, phone:e.target.value}))} />
                  </label>

                  <div></div>

                <div className="mt-2 flex flex-wrap items-center gap-2">
                  <div className="flex flex-col gap-1">
                    <label className="text-[11px] muted flex items-center gap-2">
                      <input
                        type="checkbox"
                        checked={!!form.flag}
                        onChange={(e)=>setForm(f=>({...f, flag:e.target.checked, importance: e.target.checked ? (f.importance || "normal") : "none"}))}
                      />
                      Î£Î·Î¼Î±Î¹Î¬ÎºÎ¹
                    </label>

                    <label className="text-[11px] muted">
                      Î£Î·Î¼Î±Î½Ï„Î¹ÎºÏŒÏ„Î·Ï„Î±
                      <select
                        className="cell mt-1 w-full"
                        value={(form.flag ? (form.importance || "normal") : "none")}
                        disabled={!form.flag}
                        onChange={(e)=>setForm(f=>({...f, importance:e.target.value}))}
                        style={!form.flag ? { opacity: .55, cursor: "not-allowed" } : {}}
                      >
                        {IMPORTANCE.map(x => <option key={x.key} value={x.key}>{x.label}</option>)}
                      </select>
                    </label>
                  </div>

                  <label className="text-[11px] muted flex items-center gap-2 mt-4">
                    <input
                      type="checkbox"
                      checked={!!form.done}
                      onChange={(e)=>setForm(f=>({...f, done:e.target.checked}))}
                    />
                    ÎˆÏ„Î¿Î¹Î¼Î¿
                  </label>

                  <div className="relative mt-4">
                    <button
                      type="button"
                      className="btn rounded-xl px-3 py-2 text-[12px] flex items-center gap-2"
                      onClick={()=>setColorOpen(o=>!o)}
                      title="Î•Ï€Î¹Î»Î¿Î³Î® Ï‡ÏÏÎ¼Î±Ï„Î¿Ï‚"
                    >
                      <span className="mc-dot" style={{ background: form.color || MC_COLORS[0] }}></span>
                      Î§ÏÏÎ¼Î±
                    </button>

                    {colorOpen && (
                      <div className="panel-strong p-3 mc-palette-panel">
                        <div className="mc-palette">
                          {MC_COLORS.map(c => (
                            <button
                              key={c}
                              type="button"
                              className="mc-color-btn"
                              style={{ background: c }}
                              onClick={()=>{ setForm(f=>({...f, color:c})); setColorOpen(false);}}
                              title={c}
                            />
                          ))}
                        </div>
                      </div>
                    )}
                  </div>
                </div>

                </div>

                <label className="text-[11px] muted block mt-2">
                  Î£Î·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚
                  <textarea className="cell mt-1 w-full" rows="5" value={form.notes} onChange={(e)=>setForm(f=>({...f, notes:e.target.value}))}></textarea>
                </label>

                <div className="flex items-center justify-end gap-2 mt-3">
                  <button className="btn rounded-xl px-4 py-2 text-[12px]" onClick={saveItem}>Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·</button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    // ===========================
    // Tasks (14-day Timeline) per Tour Operator
    // ===========================
    function TasksTimeline({ operator }) {
      const META_KEY = React.useMemo(() => `timeline14.${(operator||"").toLowerCase()}.multi.meta.v2`, [operator]);
      const TASK_KEY = React.useCallback((id) => `timeline14.${(operator||"").toLowerCase()}.task.${id}.v2`, [operator]);

      const pad = (n) => String(n).padStart(2, "0");
      const toISO = (d) => {
        const x = new Date(d);
        x.setHours(0,0,0,0);
        return `${x.getFullYear()}-${pad(x.getMonth()+1)}-${pad(x.getDate())}`;
      };
      const addDays = (iso, delta) => {
        const [y,m,dd] = (iso||toISO(new Date())).split("-").map(Number);
        const d = new Date(y, (m||1)-1, dd||1);
        d.setDate(d.getDate() + delta);
        return toISO(d);
      };
      const fmtDayBtn = (iso) => {
        const [y,m,d] = (iso||"").split("-").map(Number);
        const dt = new Date(y, (m||1)-1, d||1);
        return dt.toLocaleDateString("el-GR", { weekday:"short", day:"2-digit", month:"2-digit" });
      };
      const fmtMonth = (iso) => {
        const [y,m,d] = (iso||"").split("-").map(Number);
        const dt = new Date(y, (m||1)-1, d||1);
        return dt.toLocaleDateString("el-GR", { month:"long", year:"numeric" });
      };

      const uid = () => Math.random().toString(16).slice(2) + Date.now().toString(16);
      const clone = (x) => JSON.parse(JSON.stringify(x));

      const loadMeta = () => {
        try{
          const raw = localStorage.getItem(META_KEY);
          if (raw){
            const m = JSON.parse(raw);
            if (m && Array.isArray(m.tasks) && m.tasks.length) return m;
          }
        }catch{}
        const firstId = uid();
        const meta = { tasks: [{ id: firstId, name: "TASK", color: "#60a5fa" }], activeId: firstId };
        localStorage.setItem(META_KEY, JSON.stringify(meta));
        const initState = makeEmptyTaskState();
        localStorage.setItem(TASK_KEY(firstId), JSON.stringify(initState));
        return meta;
      };

      const makeEmptyTaskState = () => {
        const today = new Date();
        const todayKey = toISO(today);
        return {
          windowStart: todayKey,
          today: Date.now(),
          selectedDayKey: null,
          selectedRow: null, // { dayKey, index }
          data: {
            lastVisited: todayKey,
            tasksByDate: {}
          }
        };
      };

      const loadTask = (id) => {
        try{
          const raw = localStorage.getItem(TASK_KEY(id));
          if (raw){
            const st = JSON.parse(raw);
            if (st && st.data && st.data.tasksByDate) return st;
          }
        }catch{}
        const st = makeEmptyTaskState();
        localStorage.setItem(TASK_KEY(id), JSON.stringify(st));
        return st;
      };

      const saveMeta = (m) => { localStorage.setItem(META_KEY, JSON.stringify(m)); window.dispatchEvent(new Event("tasks-updated")); };
      const saveTask = (id, st) => { localStorage.setItem(TASK_KEY(id), JSON.stringify(st)); window.dispatchEvent(new Event("tasks-updated")); };

      const ensureRows = (tasksByDate, dayKey, minRows=5) => {
        const arr = Array.isArray(tasksByDate[dayKey]) ? tasksByDate[dayKey] : [];
        while (arr.length < minRows) arr.push({ id: uid(), text:"", done:false, moved:false });
        tasksByDate[dayKey] = arr;
      };

      const rolloverUnfinished = (st) => {
        const todayKey = toISO(new Date());
        const last = st?.data?.lastVisited;
        if (!last || last === todayKey) {
          st.data.lastVisited = todayKey;
          return st;
        }
        // move day by day from last -> today
        let cur = last;
        while (cur !== todayKey) {
          const next = addDays(cur, 1);
          const byDate = st.data.tasksByDate;
          ensureRows(byDate, cur);
          ensureRows(byDate, next);
          const from = byDate[cur] || [];
          const to = byDate[next] || [];
          const move = from.filter(x => x && !x.done && (x.text||"").trim() !== "");
          const keep = from.filter(x => x && (x.done || (x.text||"").trim()===""));
          // append to end on auto rollover (no moved highlight)
          byDate[cur] = keep.length ? keep : [];
          byDate[next] = [...to, ...move.map(x => ({ ...x, id: uid(), done:false, moved:false }))];
          cur = next;
        }
        st.data.lastVisited = todayKey;
        return st;
      };

      const [meta, setMeta] = React.useState(() => loadMeta());
      const [activeId, setActiveId] = React.useState(() => loadMeta().activeId);
      const [state, setState] = React.useState(() => {
        const m = loadMeta();
        const st = rolloverUnfinished(loadTask(m.activeId));
        // always start from today (spec)
        st.windowStart = toISO(new Date());
        st.today = Date.now();
        saveTask(m.activeId, st);
        return st;
      });

      // keep meta.activeId synced
      React.useEffect(() => {
        setMeta(prev => {
          const next = { ...(prev || loadMeta()), activeId };
          saveMeta(next);
          return next;
        });
      }, [activeId]);

      // load task when active changes
      React.useEffect(() => {
        const st = rolloverUnfinished(loadTask(activeId));
        st.windowStart = toISO(new Date());
        st.today = Date.now();
        saveTask(activeId, st);
        setState(st);
      }, [activeId, operator]);

      const activeTask = React.useMemo(() => (meta?.tasks || []).find(t => t.id === activeId) || null, [meta, activeId]);

      const days = React.useMemo(() => {
        const start = state?.windowStart || toISO(new Date());
        return Array.from({length:14}, (_,i)=> addDays(start,i));
      }, [state?.windowStart]);

      const setAndPersist = (updater) => {
        setState(prev => {
          const next = typeof updater === "function" ? updater(clone(prev)) : clone(updater);
          saveTask(activeId, next);
          return next;
        });
      };

      const pickTask = (id) => setActiveId(id);

      const addTask = () => {
        const name = prompt("ÎŒÎ½Î¿Î¼Î± Î½Î­Î¿Ï… Task:");
        if (!name) return;
        const id = uid();
        const color = "#60a5fa";
        const nextMeta = {
          ...(meta || loadMeta()),
          tasks: [ ...(meta?.tasks || []), { id, name, color } ],
          activeId: id
        };
        saveMeta(nextMeta);
        saveTask(id, makeEmptyTaskState());
        setMeta(nextMeta);
        setActiveId(id);
      };

      const renameTask = (id) => {
        const t = (meta?.tasks || []).find(x => x.id===id);
        const name = prompt("ÎÎ­Î¿ ÏŒÎ½Î¿Î¼Î±:", t?.name || "");
        if (!name) return;
        const nextMeta = { ...meta, tasks: meta.tasks.map(x => x.id===id ? { ...x, name } : x) };
        saveMeta(nextMeta); setMeta(nextMeta);
      };

      const recolorTask = (id) => {
        const t = (meta?.tasks || []).find(x => x.id===id);
        const color = prompt("Î§ÏÏÎ¼Î± (hex), Ï€.Ï‡. #60a5fa", t?.color || "#60a5fa");
        if (!color) return;
        const nextMeta = { ...meta, tasks: meta.tasks.map(x => x.id===id ? { ...x, color } : x) };
        saveMeta(nextMeta); setMeta(nextMeta);
      };

      const deleteTask = (id) => {
        const t = (meta?.tasks || []).find(x => x.id===id);
        if (!confirm(`Î”Î¹Î±Î³ÏÎ±Ï†Î® task "${t?.name || "TASK"}";`)) return;
        try{ localStorage.removeItem(TASK_KEY(id)); }catch{}
        const remaining = (meta?.tasks || []).filter(x => x.id!==id);
        if (!remaining.length){
          const fresh = loadMeta(); // recreates default
          setMeta(fresh);
          setActiveId(fresh.activeId);
          return;
        }
        const nextActive = (activeId === id) ? remaining[0].id : activeId;
        const nextMeta = { ...meta, tasks: remaining, activeId: nextActive };
        saveMeta(nextMeta);
        setMeta(nextMeta);
        setActiveId(nextActive);
      };

      const onTaskContext = (e, id) => {
        e.preventDefault();
        const action = prompt("Î•Î½Î­ÏÎ³ÎµÎ¹Î±: r=ÎœÎµÏ„Î¿Î½Î¿Î¼Î±ÏƒÎ¯Î±, d=Î”Î¹Î±Î³ÏÎ±Ï†Î®, c=Î§ÏÏÎ¼Î±", "r");
        if (!action) return;
        const a = action.toLowerCase().trim();
        if (a === "r") renameTask(id);
        if (a === "d") deleteTask(id);
        if (a === "c") recolorTask(id);
      };

      const shiftWindow = (delta) => {
        setAndPersist(st => {
          st.windowStart = addDays(st.windowStart || toISO(new Date()), delta);
          st.selectedDayKey = null;
          st.selectedRow = null;
          return st;
        });
      };

      const gotoToday = () => {
        setAndPersist(st => {
          st.windowStart = toISO(new Date());
          st.selectedDayKey = null;
          st.selectedRow = null;
          return st;
        });
      };

      const jumpTo = (iso) => {
        if (!iso) return;
        setAndPersist(st => {
          st.windowStart = iso;
          st.selectedDayKey = null;
          st.selectedRow = null;
          return st;
        });
      };

      const addRowToSelectedDay = () => {
        setAndPersist(st => {
          const dayKey = st.selectedDayKey;
          if (!dayKey) return st;
          const byDate = st.data.tasksByDate;
          ensureRows(byDate, dayKey, 0);
          byDate[dayKey].push({ id: uid(), text:"", done:false, moved:false });
          return st;
        });
      };

      const deleteSelectedRow = () => {
        setAndPersist(st => {
          const sel = st.selectedRow;
          if (!sel) return st;
          const arr = st.data.tasksByDate?.[sel.dayKey];
          if (!Array.isArray(arr)) return st;
          arr.splice(sel.index, 1);
          st.selectedRow = null;
          return st;
        });
      };

      const manualSave = () => {
        try{ saveTask(activeId, state); alert("ÎŸÎ¹ Î±Î»Î»Î±Î³Î­Ï‚ Î±Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎ±Î½!"); }catch{}
      };


      const clearActive = () => {
        const label = `${activeTask?.name || "TASK"} â€” ${operator}`;
        if (!confirm(`ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚ ÏŒÎ»Ï‰Î½ Ï„Ï‰Î½ ÎºÎµÎ»Î¹ÏÎ½ Î³Î¹Î±: ${label};`)) return;
        setAndPersist(st => {
          st.data.tasksByDate = {};
          // reset visible window days to empty rows
          (days || []).forEach(dk => {
            st.data.tasksByDate[dk] = [];
            ensureRows(st.data.tasksByDate, dk);
          });
          st.selectedDayKey = null;
          st.selectedRow = null;
          return st;
        });
      };

      const exportAll = () => {
        const m = loadMeta();
        const dump = { meta: m, tasks: {} };
        (m.tasks||[]).forEach(t => {
          dump.tasks[t.id] = loadTask(t.id);
        });
        const blob = new Blob([JSON.stringify(dump, null, 2)], { type:"application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `timeline-backup-${toISO(new Date())}.json`;
        document.body.appendChild(a); a.click(); a.remove();
        setTimeout(()=>URL.revokeObjectURL(url), 1000);
      };

      const importAll = async () => {
        const inp = document.createElement("input");
        inp.type = "file";
        inp.accept = ".json,application/json";
        inp.onchange = async () => {
          const f = inp.files?.[0];
          if (!f) return;
          try{
            const text = await f.text();
            const dump = JSON.parse(text);
            if (!dump?.meta || !dump?.tasks) throw new Error("ÎœÎ· Î­Î³ÎºÏ…ÏÎ¿ backup.");
            localStorage.setItem(META_KEY, JSON.stringify(dump.meta));
            Object.keys(dump.tasks).forEach(id => {
              localStorage.setItem(TASK_KEY(id), JSON.stringify(dump.tasks[id]));
            });
            location.reload();
          }catch(e){
            alert("Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î± restore: " + (e?.message || "ÏƒÏ†Î¬Î»Î¼Î±"));
          }
        };
        inp.click();
      };

      const rolloverNow = () => {
        const todayKey = toISO(new Date());
        const tomorrowKey = addDays(todayKey, 1);
        setAndPersist(st => {
          const byDate = st.data.tasksByDate;
          ensureRows(byDate, todayKey);
          ensureRows(byDate, tomorrowKey);
          const from = byDate[todayKey] || [];
          const to = byDate[tomorrowKey] || [];

          const move = from.filter(x => x && !x.done && (x.text||"").trim() !== "");
          if (!move.length){
            alert("Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î¼Î· Î¿Î»Î¿ÎºÎ»Î·ÏÏ‰Î¼Î­Î½Î± Î³Î¹Î± Î¼ÎµÏ„Î±Ï†Î¿ÏÎ¬.");
            return st;
          }
          const keep = from.filter(x => x && (x.done || (x.text||"").trim()===""));
          byDate[todayKey] = keep;
          const moved = move.map(x => ({ id: uid(), text: x.text, done:false, moved:true }));
          byDate[tomorrowKey] = [...moved, ...to];
          st.selectedDayKey = tomorrowKey;
          st.selectedRow = null;
          return st;
        });
      };

      const setDaySelected = (dayKey) => {
        setAndPersist(st => {
          st.selectedDayKey = dayKey;
          st.selectedRow = null;
          return st;
        });
      };

      const setRowSelected = (dayKey, index) => {
        setAndPersist(st => {
          st.selectedRow = { dayKey, index };
          st.selectedDayKey = dayKey;
          return st;
        });
      };

      const toggleDone = (dayKey, index) => {
        setAndPersist(st => {
          const arr = st.data.tasksByDate?.[dayKey] || [];
          if (!arr[index]) return st;
          arr[index].done = !arr[index].done;
          if (arr[index].done) arr[index].moved = false;
          return st;
        });
      };

      const setText = (dayKey, index, textVal) => {
        setAndPersist(st => {
          const byDate = st.data.tasksByDate;
          ensureRows(byDate, dayKey);
          byDate[dayKey][index].text = textVal;
          byDate[dayKey][index].moved = false;
          return st;
        });
      };

      // Ensure data for visible days
      React.useEffect(() => {
        setAndPersist(st => {
          const byDate = st.data.tasksByDate;
          days.forEach(dk => ensureRows(byDate, dk));
          return st;
        });
        // eslint-disable-next-line react-hooks/exhaustive-deps
      }, [activeId, state?.windowStart]);

      // UI
      return (
        <div className="h-full flex gap-3">
          <div className="w-[240px] panel-strong p-3 flex flex-col overflow-hidden">
            <div className="flex items-center justify-between">
              <div className="font-extrabold text-[13px]">Tasks</div>
              <button className="btn rounded-xl px-2 py-1 text-[12px]" onClick={addTask} title="ÎÎ­Î¿ task">+</button>
            </div>
            <div className="divider my-2"></div>
            <div className="flex-1 overflow-auto scrollbar space-y-2">
              {(meta?.tasks || []).map(t => (
                <button
                  key={t.id}
                  onClick={() => pickTask(t.id)}
                  onContextMenu={(e) => onTaskContext(e, t.id)}
                  className={"btn w-full rounded-xl px-3 py-2 text-left " + (t.id===activeId ? "opacity-100" : "opacity-90")}
                  style={t.id===activeId ? { borderColor: t.color, boxShadow: `0 0 0 1px ${t.color}55 inset` } : {}}
                  title="Î”ÎµÎ¾Î¯ ÎºÎ»Î¹Îº: rename/delete/color"
                >
                  <div className="font-semibold text-[12px]">{t.name}</div>
                  <div className="muted text-[11px]">{operator}</div>
                </button>
              ))}
            </div>
          </div>

          <div className="flex-1 panel-strong p-3 overflow-hidden flex flex-col">
            <div className="flex items-start justify-between gap-3">
              <div>
                <div className="text-[15px] font-extrabold tracking-tight">
                  {(activeTask?.name || "TASK")} â€” Timeline
                  <span className="muted font-semibold"> / {operator}</span>
                </div>
                <div className="text-[11px] muted mt-0.5">14 Î·Î¼Î­ÏÎµÏ‚ â€¢ Î±Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· Î±Î½Î¬ operator ÏƒÏ„Î¿ localStorage</div>
              </div>
              <div className="flex flex-wrap gap-2 items-center justify-end">
                <button className="btn rounded-xl px-3 py-2 text-[12px]" onClick={() => shiftWindow(-1)}>â—€</button>
                <button className="btn rounded-xl px-3 py-2 text-[12px]" onClick={() => shiftWindow(1)}>â–¶</button>
                <button className="btn rounded-xl px-3 py-2 text-[12px]" onClick={gotoToday}>Î£Î®Î¼ÎµÏÎ±</button>

                <input
                  className="dark-date-input"
                  type="date"
                  value={state?.windowStart || toISO(new Date())}
                  onChange={(e) => jumpTo(e.target.value)}
                  title="Jump"
                />

                <button className={"btn rounded-xl px-3 py-2 text-[12px] " + (!state?.selectedDayKey ? "opacity-50" : "")}
                        disabled={!state?.selectedDayKey}
                        onClick={addRowToSelectedDay}>+ Î“ÏÎ±Î¼Î¼Î®</button>

                <button className={"btn rounded-xl px-3 py-2 text-[12px] " + (!state?.selectedRow ? "opacity-50" : "")}
                        disabled={!state?.selectedRow}
                        onClick={deleteSelectedRow}>âœ–</button>

                <button className="btn rounded-xl px-3 py-2 text-[12px]" onClick={manualSave}>ğŸ’¾</button>
                <button className="btn rounded-xl px-3 py-2 text-[12px]" onClick={exportAll}>â¬‡</button>
                <button className="btn rounded-xl px-3 py-2 text-[12px]" onClick={importAll}>â¬†</button>
                <button className="btn rounded-xl px-3 py-2 text-[12px]" onClick={rolloverNow}>â†ª</button>
                <button className="btn rounded-xl px-3 py-2 text-[12px]" onClick={clearActive} title="ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚">ğŸ§¹</button>
              </div>
            </div>

            <div className="divider my-3"></div>

            <div className="grid-wrap panel scrollbar flex-1">
              <table className="tasks-table">
                <thead>
                  <tr>
                    <th className="rownum-th">Î—Î¼Î­ÏÎ±</th>
                    <th>â„–</th>
                    <th>âœ“</th>
                    <th>Task</th>
                  </tr>
                </thead>
                <tbody>
                  {(() => {
                    const rowsEls = [];
                    let lastMonth = "";
                    days.forEach((dayKey) => {
                      const month = fmtMonth(dayKey);
                      if (month !== lastMonth){
                        lastMonth = month;
                        rowsEls.push(
                          <tr key={"m_"+dayKey}>
                            <td colSpan={4} style={{ position:"sticky", top:0, zIndex: 8, background:"rgba(255,255,255,.03)" }}>
                              <div className="font-extrabold">{month}</div>
                            </td>
                          </tr>
                        );
                      }

                      const arr = (state?.data?.tasksByDate?.[dayKey] || []);
                      const safe = arr.length ? arr : [];
                      const dayRows = Math.max(5, safe.length);

                      for (let i=0;i<dayRows;i++){
                        const item = safe[i] || { id: uid(), text:"", done:false, moved:false };
                        if (i===0){
                          rowsEls.push(
                            <tr key={dayKey+"_"+i}>
                              <td rowSpan={dayRows} className={"rownum " + (state?.selectedDayKey===dayKey ? "selected" : "")}
                                  onClick={() => setDaySelected(dayKey)}>
                                <div className="font-extrabold">{fmtDayBtn(dayKey)}</div>
                                <div className="muted text-[11px]">{dayKey}</div>
                              </td>
                              <td className={"rownum " + (state?.selectedRow?.dayKey===dayKey && state?.selectedRow?.index===i ? "selected" : "")}
                                  onClick={() => setRowSelected(dayKey, i)}>
                                {i+1}
                              </td>
                              <td style={{ textAlign:"center" }}>
                                <input className="checkbox" type="checkbox" checked={!!item.done} onChange={() => toggleDone(dayKey,i)} />
                              </td>
                              <td>
                                <textarea
                                  className={"cell task-cell " + (item.moved ? "ring-2 ring-sky-400/40" : "")}
                                  rows={1}
                                  value={item.text || ""}
                                  onInput={(e) => {
                                    const el = e.target;
                                    el.style.height = "auto";
                                    el.style.height = el.scrollHeight + "px";
                                  }}
                                  onChange={(e)=>setText(dayKey,i,e.target.value)}
                                />
                              </td>
                            </tr>
                          );
                        } else {
                          rowsEls.push(
                            <tr key={dayKey+"_"+i}>
                              <td className={"rownum " + (state?.selectedRow?.dayKey===dayKey && state?.selectedRow?.index===i ? "selected" : "")}
                                  onClick={() => setRowSelected(dayKey, i)}>
                                {i+1}
                              </td>
                              <td style={{ textAlign:"center" }}>
                                <input className="checkbox" type="checkbox" checked={!!item.done} onChange={() => toggleDone(dayKey,i)} />
                              </td>
                              <td>
                                <textarea
                                  className={"cell task-cell " + (item.moved ? "ring-2 ring-sky-400/40" : "")}
                                  rows={1}
                                  value={item.text || ""}
                                  onInput={(e) => {
                                    const el = e.target;
                                    el.style.height = "auto";
                                    el.style.height = el.scrollHeight + "px";
                                  }}
                                  onChange={(e)=>setText(dayKey,i,e.target.value)}
                                />
                              </td>
                            </tr>
                          );
                        }
                      }
                    });
                    return rowsEls;
                  })()}
                </tbody>
              </table>
            </div>

            <div className="mt-2 muted text-[11px]">
              Tip: Î´ÎµÎ¾Î¯ ÎºÎ»Î¹Îº Ï€Î¬Î½Ï‰ ÏƒÎµ Task ÎºÎ¿Ï…Î¼Ï€Î¯ â†’ rename / delete / color.
            </div>
          </div>
        </div>
      );
    }

    // ===========================
    // Task (Soon) â€” Î£Ï…Î³ÎºÎµÎ½Ï„ÏÏ‰Ï„Î¹ÎºÏŒÏ‚ Ï€Î¯Î½Î±ÎºÎ±Ï‚ Tasks (14 Î·Î¼Î­ÏÎµÏ‚) Î±Ï€ÏŒ ÎŸÎ›ÎŸÎ¥Î£ Ï„Î¿Ï…Ï‚ Tour Operators
    // ===========================
    function AllOperatorsTasksTimeline(){
      const pad = (n) => String(n).padStart(2,"0");
      const toISO = (d) => {
        const x = new Date(d);
        x.setHours(0,0,0,0);
        return `${x.getFullYear()}-${pad(x.getMonth()+1)}-${pad(x.getDate())}`;
      };
      const addDays = (iso, delta) => {
        const [y,m,dd] = (iso||toISO(new Date())).split("-").map(Number);
        const d = new Date(y, (m||1)-1, dd||1);
        d.setDate(d.getDate() + delta);
        return toISO(d);
      };
      const fmtDayBtn = (iso) => {
        const [y,m,d] = (iso||"").split("-").map(Number);
        const dt = new Date(y, (m||1)-1, d||1);
        return dt.toLocaleDateString("el-GR", { weekday:"short", day:"2-digit", month:"2-digit" });
      };
      const fmtMonth = (iso) => {
        const [y,m,d] = (iso||"").split("-").map(Number);
        const dt = new Date(y, (m||1)-1, d||1);
        return dt.toLocaleDateString("el-GR", { month:"long", year:"numeric" });
      };

      const OP_ORDER = React.useMemo(() => TOUR_OPERATORS.map(x => (x||"").toLowerCase()), []);
      const ensureMinRows = (arr, min=5) => {
        const out = Array.isArray(arr) ? [...arr] : [];
        while (out.length < min) out.push(null);
        return out;
      };

      const [windowStart, setWindowStart] = React.useState(() => toISO(new Date()));
      const [selectedDayKey, setSelectedDayKey] = React.useState(null);
      const [selectedRow, setSelectedRow] = React.useState(null); // { dayKey, index }
      const [snapshot, setSnapshot] = React.useState({}); // byDate: { [iso]: [{op, opKey, taskId, itemId, dayKey, indexInOp, text, done}] }

      const days = React.useMemo(() => Array.from({ length: 14 }, (_, i) => addDays(windowStart, i)), [windowStart]);

      const loadAll = React.useCallback(() => {
        const out = {};
        TOUR_OPERATORS.forEach(op => {
          const opKey = (op||"").toLowerCase();
          const META_KEY = `timeline14.${opKey}.multi.meta.v2`;
          const TASK_KEY = (id) => `timeline14.${opKey}.task.${id}.v2`;

          let meta = null;
          try{ meta = JSON.parse(localStorage.getItem(META_KEY) || "null"); }catch{ meta = null; }
          const activeId = meta?.activeId;
          if (!activeId) return;

          let st = null;
          try{ st = JSON.parse(localStorage.getItem(TASK_KEY(activeId)) || "null"); }catch{ st = null; }
          const tasksByDate = st?.data?.tasksByDate || {};

          days.forEach(dayKey => {
            const arr = Array.isArray(tasksByDate[dayKey]) ? tasksByDate[dayKey] : [];
            arr.forEach((it, idx) => {
              const text = (it?.text || "").trim();
              // ÎºÏÎ±Ï„Î¬Î¼Îµ ÎšÎ‘Î™ ÎºÎµÎ½Î¬ Î³Î¹Î± Î½Î± Î¼Î·Î½ â€œÏƒÏ€Î¬ÎµÎ¹â€ Î· Î±ÏÎ¯Î¸Î¼Î·ÏƒÎ·; ÎµÎ´Ï ÎºÏÎ±Ï„Î¬Î¼Îµ Î¼ÏŒÎ½Î¿ Î¼Î·-ÎºÎµÎ½Î¬
              if (!text) return;
              if (!out[dayKey]) out[dayKey] = [];
              out[dayKey].push({
                op,
                opKey,
                taskId: activeId,
                itemId: it?.id || `${opKey}_${dayKey}_${idx}`,
                dayKey,
                indexInOp: idx,
                text: it?.text || "",
                done: !!it?.done
              });
            });
          });
        });

        // Sort per day: operator order then original index
        Object.keys(out).forEach(dayKey => {
          out[dayKey].sort((a,b) => {
            const ao = OP_ORDER.indexOf(a.opKey);
            const bo = OP_ORDER.indexOf(b.opKey);
            if (ao !== bo) return ao - bo;
            return (a.indexInOp||0) - (b.indexInOp||0);
          });
        });

        setSnapshot(out);
      }, [days, OP_ORDER]);

      React.useEffect(() => {
        loadAll();
        // eslint-disable-next-line react-hooks/exhaustive-deps
      }, [windowStart]);

      React.useEffect(() => {
        const onUpd = () => loadAll();
        window.addEventListener("storage", onUpd);
        window.addEventListener("tasks-updated", onUpd);
        return () => {
          window.removeEventListener("storage", onUpd);
          window.removeEventListener("tasks-updated", onUpd);
        };
      }, [loadAll]);

      const shiftWindow = (dir) => setWindowStart(prev => addDays(prev, dir));
      const gotoToday = () => setWindowStart(toISO(new Date()));

      const setDaySelected = (dayKey) => { setSelectedDayKey(dayKey); setSelectedRow(null); };
      const setRowSelected = (dayKey, index) => { setSelectedDayKey(dayKey); setSelectedRow({ dayKey, index }); };

      const updateItem = (item, updater) => {
        if (!item) return;
        const opKey = item.opKey;
        const TASK_KEY = (id) => `timeline14.${opKey}.task.${id}.v2`;
        let st = null;
        try{ st = JSON.parse(localStorage.getItem(TASK_KEY(item.taskId)) || "null"); }catch{ st = null; }
        if (!st?.data?.tasksByDate) return;
        const arr = Array.isArray(st.data.tasksByDate[item.dayKey]) ? st.data.tasksByDate[item.dayKey] : [];
        // best-effort find by id, else by index
        let idx = arr.findIndex(x => (x?.id || "") === item.itemId);
        if (idx < 0) idx = item.indexInOp;
        if (!arr[idx]) return;

        const next = updater({ ...arr[idx] });
        arr[idx] = next;
        st.data.tasksByDate[item.dayKey] = arr;
        localStorage.setItem(TASK_KEY(item.taskId), JSON.stringify(st));
        window.dispatchEvent(new Event("tasks-updated"));
      };

      const toggleDone = (dayKey, index) => {
        const item = (snapshot?.[dayKey] || [])[index];
        updateItem(item, (it) => ({ ...it, done: !it.done, moved: false }));
      };

      const setText = (dayKey, index, textVal) => {
        const item = (snapshot?.[dayKey] || [])[index];
        updateItem(item, (it) => ({ ...it, text: textVal, moved: false }));
      };

      return (
        <div className="h-full panel-strong p-3 overflow-hidden flex flex-col">
          <div className="flex items-start justify-between gap-3">
            <div>
              <div className="text-[15px] font-extrabold tracking-tight">
                Task â€” <span className="muted font-semibold">Î£Ï…Î³ÎºÎµÎ½Ï„ÏÏ‰Ï„Î¹ÎºÏŒ (ÏŒÎ»Î¿Î¹ Î¿Î¹ operators)</span>
              </div>
              <div className="text-[11px] muted mt-0.5">ÎŠÎ´Î¹Î¿Ï‚ Ï€Î¯Î½Î±ÎºÎ±Ï‚ (Timeline 14 Î·Î¼ÎµÏÏÎ½) â€¢ Î±Ï…Ï„ÏŒÎ¼Î±Ï„Î· ÏƒÏ…Î»Î»Î¿Î³Î® Î±Ï€ÏŒ Grecos/Sunweb/BlueStyle/Satur/Palma â€¢ Ï‡ÏÏÎ¼Î± Î±Î½Î¬ operator</div>
            </div>
            <div className="flex flex-wrap gap-2 items-center justify-end">
              <button className="btn rounded-xl px-3 py-2 text-[12px]" onClick={() => shiftWindow(-1)}>â—€</button>
              <button className="btn rounded-xl px-3 py-2 text-[12px]" onClick={() => shiftWindow(1)}>â–¶</button>
              <button className="btn rounded-xl px-3 py-2 text-[12px]" onClick={gotoToday}>Î£Î®Î¼ÎµÏÎ±</button>

              <input
                className="dark-date-input"
                type="date"
                value={windowStart}
                onChange={(e) => setWindowStart(e.target.value)}
                title="Jump"
              />

              <button className="btn rounded-xl px-3 py-2 text-[12px]" onClick={loadAll}>âŸ³ Î‘Î½Î±Î½Î­Ï‰ÏƒÎ·</button>
            </div>
          </div>

          <div className="divider my-3"></div>

          <div className="grid-wrap panel scrollbar flex-1">
            <table className="tasks-table">
              <thead>
                <tr>
                  <th className="rownum-th">Î—Î¼Î­ÏÎ±</th>
                  <th>â„–</th>
                  <th>âœ“</th>
                  <th>Operator</th>
                  <th>Task</th>
                </tr>
              </thead>
              <tbody>
                {(() => {
                  const rowsEls = [];
                  let lastMonth = "";
                  days.forEach((dayKey) => {
                    const month = fmtMonth(dayKey);
                    if (month !== lastMonth){
                      lastMonth = month;
                      rowsEls.push(
                        <tr key={"m_all_"+dayKey}>
                          <td colSpan={5} style={{ position:"sticky", top:0, zIndex: 8, background:"rgba(255,255,255,.03)" }}>
                            <div className="font-extrabold">{month}</div>
                          </td>
                        </tr>
                      );
                    }

                    const arr = ensureMinRows(snapshot?.[dayKey] || [], 5);
                    const dayRows = arr.length;

                    for (let i=0;i<dayRows;i++){
                      const item = arr[i];
                      const op = item?.op || "";
                      const opCls = operatorClass(op);
                      const rowKey = dayKey + "_" + i;

                      const opPill = item ? (
                        <span className={`op-pill ${opCls}`}>{op}</span>
                      ) : (
                        <span className="muted">â€”</span>
                      );

                      const textareaClass = "cell task-cell " + (item ? `task-op ${opCls}` : "");

                      if (i===0){
                        rowsEls.push(
                          <tr key={rowKey}>
                            <td rowSpan={dayRows} className={"rownum " + (selectedDayKey===dayKey ? "selected" : "")}
                                onClick={() => setDaySelected(dayKey)}>
                              <div className="font-extrabold">{fmtDayBtn(dayKey)}</div>
                              <div className="muted text-[11px]">{dayKey}</div>
                            </td>
                            <td className={"rownum " + (selectedRow?.dayKey===dayKey && selectedRow?.index===i ? "selected" : "")}
                                onClick={() => setRowSelected(dayKey, i)}>
                              {i+1}
                            </td>
                            <td style={{ textAlign:"center" }}>
                              <input className="checkbox" type="checkbox" checked={!!item?.done} disabled={!item}
                                     onChange={() => toggleDone(dayKey,i)} />
                            </td>
                            <td>{opPill}</td>
                            <td>
                              <textarea
                                className={textareaClass}
                                rows={1}
                                value={item?.text || ""}
                                readOnly={!item}
                                placeholder={item ? "" : ""}
                                onInput={(e) => {
                                  const el = e.target;
                                  el.style.height = "auto";
                                  el.style.height = el.scrollHeight + "px";
                                }}
                                onChange={(e)=>setText(dayKey,i,e.target.value)}
                              />
                            </td>
                          </tr>
                        );
                      } else {
                        rowsEls.push(
                          <tr key={rowKey}>
                            <td className={"rownum " + (selectedRow?.dayKey===dayKey && selectedRow?.index===i ? "selected" : "")}
                                onClick={() => setRowSelected(dayKey, i)}>
                              {i+1}
                            </td>
                            <td style={{ textAlign:"center" }}>
                              <input className="checkbox" type="checkbox" checked={!!item?.done} disabled={!item}
                                     onChange={() => toggleDone(dayKey,i)} />
                            </td>
                            <td>{opPill}</td>
                            <td>
                              <textarea
                                className={textareaClass}
                                rows={1}
                                value={item?.text || ""}
                                readOnly={!item}
                                onInput={(e) => {
                                  const el = e.target;
                                  el.style.height = "auto";
                                  el.style.height = el.scrollHeight + "px";
                                }}
                                onChange={(e)=>setText(dayKey,i,e.target.value)}
                              />
                            </td>
                          </tr>
                        );
                      }
                    }
                  });
                  return rowsEls;
                })()}
              </tbody>
            </table>
          </div>

          <div className="mt-2 muted text-[11px]">
            Î£Î·Î¼ÎµÎ¯Ï‰ÏƒÎ·: ÎµÎ´Ï ÎµÎ¼Ï†Î±Î½Î¯Î¶Î¿Î½Ï„Î±Î¹ Î¼ÏŒÎ½Î¿ Î¿Î¹ <b>Î¼Î·-ÎºÎµÎ½Î­Ï‚</b> Î³ÏÎ±Î¼Î¼Î­Ï‚ Î±Ï€ÏŒ Ï„Î¿ ÎµÎ½ÎµÏÎ³ÏŒ Task-list (active) ÎºÎ¬Î¸Îµ operator.
          </div>
        </div>
      );
    }

function App(){
      const [activeSection, setActiveSection] = React.useState("Tour Operator");

      // ALL CLOSED on load
      const [tourOpen, setTourOpen] = React.useState(false);
      const [ttOpen, setTtOpen] = React.useState(false);
      const [ttTab, setTtTab] = React.useState("Transfer");

      const [opOpen, setOpOpen] = React.useState(() => Object.fromEntries(TOUR_OPERATORS.map(o => [o, false])));
      const [hotelsOpen, setHotelsOpen] = React.useState(() => Object.fromEntries(TOUR_OPERATORS.map(o => [o, false])));
      const [transfersOpen, setTransfersOpen] = React.useState(() => Object.fromEntries(TOUR_OPERATORS.map(o => [o, false])));
      const [tasksOpen, setTasksOpen] = React.useState(() => Object.fromEntries(TOUR_OPERATORS.map(o => [o, false])));


      const [activeOperator, setActiveOperator] = React.useState(null);

      const [columnsByOp, setColumnsByOp] = React.useState(() => {
        const obj = {};
        TOUR_OPERATORS.forEach(op => obj[op] = [...DEFAULT_COLUMNS]);
        return obj;
      });

      const [rowsByOp, setRowsByOp] = React.useState(() => {
        const obj = {};
        TOUR_OPERATORS.forEach(op => {
          const saved = localStorage.getItem(storageKey(op));
          if (saved){
            try{
              const parsed = JSON.parse(saved);
              const cols = Array.isArray(parsed.columns) && parsed.columns.length ? parsed.columns : DEFAULT_COLUMNS;
              const rows = Array.isArray(parsed.rows) && parsed.rows.length ? parsed.rows : [emptyRow(cols), emptyRow(cols)];
              obj[op] = rows;
              return;
            }catch{}
          }
          obj[op] = [emptyRow(DEFAULT_COLUMNS), emptyRow(DEFAULT_COLUMNS)];
        });
        return obj;
      });

      const [searchByOp, setSearchByOp] = React.useState(() => Object.fromEntries(TOUR_OPERATORS.map(o => [o, ""])));
      const [selectedRowByOp, setSelectedRowByOp] = React.useState(() => Object.fromEntries(TOUR_OPERATORS.map(o => [o, null])));
      const [selectedColByOp, setSelectedColByOp] = React.useState(() => Object.fromEntries(TOUR_OPERATORS.map(o => [o, null])));

      const fileInputRef = React.useRef(null);
      const excelInputRef = React.useRef(null);



      
      // ===== Transfers store (per operator) =====
      const todayISO = React.useCallback(() => {
        const d = new Date();
        d.setHours(0,0,0,0);
        const pad = (n) => String(n).padStart(2,"0");
        return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
      }, []);

      const [transfersByOp, setTransfersByOp] = React.useState(() => {
        const obj = {};
        TOUR_OPERATORS.forEach(op => {
          const saved = localStorage.getItem(transfersStorageKey(op));
          if (saved){
            try{ obj[op] = JSON.parse(saved) || []; return; }catch{}
          }
          obj[op] = [];
        });
        return obj;
      });

      // Transfers/Tours (global) start date for the aggregated calendar
      const [ttStartISO, setTtStartISO] = React.useState(() => todayISO());

const [transfersStartByOp, setTransfersStartByOp] = React.useState(() => {
        const obj = {};
        TOUR_OPERATORS.forEach(op => {
          const saved = localStorage.getItem(transfersStartKey(op));
          if (saved){
            try{ obj[op] = JSON.parse(saved); return; }catch{}
          }
          obj[op] = null;
        });
        return obj;
      });

      const [transfersStatusByOp, setTransfersStatusByOp] = React.useState(() =>
        Object.fromEntries(TOUR_OPERATORS.map(o => [o, "Î”ÎµÎ½ Î­Ï‡Î¿Ï…Î½ ÎµÎ¹ÏƒÎ±Ï‡Î¸ÎµÎ¯ Î´ÎµÎ´Î¿Î¼Î­Î½Î±"]))
      );

      const transfersFileRef = React.useRef(null);
      const [privateModal, setPrivateModal] = React.useState({ open:false, item:null });

const [colWidths, setColWidths] = React.useState({});
      const DEFAULT_COLUMN_WIDTHS = { board: 48, stars: 64, aa: 60, city: 120, accomodation: 240, phone: 140, email: 180, hotel_total_beds: 120 };

const [modalOpen, setModalOpen] = React.useState(false);
const [editingRowIndex, setEditingRowIndex] = React.useState(null);
const [draftRow, setDraftRow] = React.useState(null);
const modalFileInputRef = React.useRef(null);



const openRowForm = (rowIndex) => {
  if (!currentOp) return;

  const base = rows[rowIndex] || emptyRow(cols);

  // Î‘Î½ Î´ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Î®Î´Î· roomTable ÏƒÏ„Î¿ row, Î´Î·Î¼Î¹Î¿Ï…ÏÎ³ÎµÎ¯ default 10x6
  const roomTable = base.roomTable && base.roomTable.columns && base.roomTable.rows
    ? base.roomTable
    : makeRoomTable(10);

  setEditingRowIndex(rowIndex);
  setDraftRow({ ...base, roomTable, hotel_total_beds: recalcTotalHotelBeds(roomTable) });
  setModalOpen(true);
};


const closeRowForm = () => {
  setModalOpen(false);
  setEditingRowIndex(null);
  setDraftRow(null);
};

const handleModalImport = async (file) => {
  try {
    const name = (file?.name || "").toLowerCase();
    const isPdf = name.endsWith(".pdf") || file.type === "application/pdf";

    
const sanitizeAccommodation = (value) => {
  return (value || "")
    .replace(/\b(appartementen|apparthotel)\b/gi, "")
    .replace(/\s*\([^)]*\)\s*/g, " ")
    .replace(/\s+/g, " ")
    .trim();
};

const cleanAccommodation = (s) => (s || "").replace(/\s*\([^)]*\)\s*/g, " ").replace(/\s+/g, " ").trim();
    const firstWord = (s) => ((s || "").trim().split(/\s+/)[0] || "").trim();

    const mapBoard = (s) => {
      const t = (s||"").toLowerCase();
      if (t.includes("room only")) return "RO";
      if (t.includes("bed and breakfast")) return "BB";
      if (t.includes("half board")) return "HB";
      if (t.includes("full board")) return "FB";
      if (t.includes("all inclusive")) return "AI";
      return "";
    };

    // ---------- JSON ----------
    if (!isPdf){
      const text = await file.text();
      const parsed = JSON.parse(text);
      const source = parsed?.rows?.[0] || parsed;

      setDraftRow(prev => {
        const next = { ...(prev || {}) };
        Object.keys(next).forEach(k => {
          if (source?.[k] === undefined) return;
          if (typeof next[k] === "boolean"){
            if (source[k] === true) next[k] = true;
          } else {
            if (next[k] === "" || next[k] == null) next[k] = source[k];
          }
        });
        return next;
      });
      alert("Î¤Î± Ï€ÎµÎ´Î¯Î± ÏƒÏ…Î¼Ï€Î»Î·ÏÏÎ¸Î·ÎºÎ±Î½ Î±Ï€ÏŒ JSON âœ…");
      return;
    }

    // ---------- PDF ----------
    if (!window.pdfjsLib) throw new Error("Î”ÎµÎ½ Ï†Î¿ÏÏ„ÏÎ¸Î·ÎºÎµ Ï„Î¿ pdf.js");
    const buf = await file.arrayBuffer();
    const pdf = await window.pdfjsLib.getDocument({ data: buf, disableWorker: true }).promise;

    let textAll = "";
    const pages = Math.min(2, pdf.numPages || 1);
    for (let i=1;i<=pages;i++){
      const page = await pdf.getPage(i);
      const content = await page.getTextContent();
      textAll += content.items.map(it => it.str).join(" ") + " ";
    }

    const lower = textAll.toLowerCase();

    let accomodation = "";
    let stars = "";
    const m1 = textAll.match(/Accommodation Contract[\s\S]{0,120}?([A-Za-zÎ‘-Î©Î±-Ï‰0-9 .&'â€™-]+?)\s*\((\d+(?:\.\d+)?)\)/i);
    if (m1){
      accomodation = cleanAccommodation(m1[1]);
      stars = m1[2];
    }

    let city = "";
    const mc = textAll.match(/\b\d{3,5}\b[\s,]+([A-Za-zÎ‘-Î©Î±-Ï‰]+)/);
    if (mc) city = firstWord(mc[1]);

    let board = "";
    const mb = textAll.match(/Possible meal plans[\s\S]{0,80}?(Room only|Bed and Breakfast|Half board|Full board|All inclusive)/i);
    if (mb) board = mapBoard(mb[1]);

    const emails = Array.from(textAll.matchAll(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/gi)).map(x=>x[0]);
    const email = emails.find(e=>!e.toLowerCase().includes("sunweb")) || emails[0] || "";

    const allotment = lower.includes("allotment");
    const pool = lower.includes("pool");
    const signed = lower.includes("signature") || lower.includes("initials");

    setDraftRow(prev => {
      const next = { ...(prev || {}) };
      if (!next.accomodation) next.accomodation = accomodation;
      if (!next.city) next.city = city;
      if (!next.board) next.board = board;
      if (!next.stars) next.stars = stars;
      if (!next.email) next.email = email;
      if (allotment) next.allotment = true;
      if (pool) next.pool = true;
      if (signed) next.signed = true;
      return next;
    });

    alert("Î¤Î± Ï€ÎµÎ´Î¯Î± ÏƒÏ…Î¼Ï€Î»Î·ÏÏÎ¸Î·ÎºÎ±Î½ Î±Ï€ÏŒ PDF âœ…");
  } catch (e) {
    alert("Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î± ÏƒÏ…Î³Ï‡ÏÎ¿Î½Î¹ÏƒÎ¼Î¿Ï: " + (e?.message || "ÏƒÏ†Î¬Î»Î¼Î±"));
  }
};



const saveRowForm = () => {
  if (editingRowIndex == null || !draftRow) return;
  setRowsByOp(prev => {
    const next = { ...prev };
    const copy = [...next[currentOp]];
    copy[editingRowIndex] = { ...copy[editingRowIndex], ...draftRow };
    next[currentOp] = copy;
    return next;
  });
  closeRowForm();
};

const setDraftCell = (colKey, value) => {
  setDraftRow(prev => ({ ...(prev || {}), [colKey]: value }));
};


const roomTableAddRow = () => {
  setDraftRow(prev => {
    if (!prev?.roomTable) return prev;
    const { columns, rows } = prev.roomTable;
    const newRow = {};
    columns.forEach(c => (newRow[c.key] = ""));
    return {
      ...prev,
      roomTable: {
        ...prev.roomTable,
        rows: [...rows, newRow],
      },
    };
  });
};

const roomTableAddCol = () => {
  const name = prompt("ÎŒÎ½Î¿Î¼Î± Î½Î­Î±Ï‚ ÏƒÏ„Î®Î»Î·Ï‚ (Room table):");
  if (!name) return;

  const keyBase = name.toLowerCase().trim().replace(/\s+/g, "_").replace(/[^\w]/g, "") || "col";
  const key = keyBase + "_" + Math.random().toString(16).slice(2, 6);

  setDraftRow(prev => {
    if (!prev?.roomTable) return prev;
    const nextCols = [...prev.roomTable.columns, { key, label: name }];
    const nextRows = prev.roomTable.rows.map(r => ({ ...r, [key]: "" }));
    return {
      ...prev,
      roomTable: { columns: nextCols, rows: nextRows },
    };
  });
};


const recalcTotalHotelBeds = (roomTable) => {
  if (!roomTable) return 0;
  return roomTable.rows.reduce((sum, r) => {
    const v = Number(r?.total_max_beds);
    return sum + (isNaN(v) ? 0 : v);
  }, 0);
};

const setRoomCell = (rIndex, cKey, value) => {
  setDraftRow(prev => {
    if (!prev?.roomTable) return prev;
    const nextRows = [...prev.roomTable.rows];
    nextRows[rIndex] = { ...(nextRows[rIndex] || {}), [cKey]: value };
    const nextRoomTable = { ...prev.roomTable, rows: nextRows };
    const totalHotelBeds = recalcTotalHotelBeds(nextRoomTable);
    return { 
      ...prev, 
      roomTable: nextRoomTable,
      hotel_total_beds: totalHotelBeds
    };
  });
};


// Close modal when switching operator/section
React.useEffect(() => {
  closeRowForm();
}, [currentOp, hotelsVisible, activeSection]);


      React.useEffect(() => {
        TOUR_OPERATORS.forEach(op => {
          const payload = { columns: columnsByOp[op], rows: rowsByOp[op] };
          localStorage.setItem(storageKey(op), JSON.stringify(payload));
        });
      }, [columnsByOp, rowsByOp]);

      
      React.useEffect(() => {
        TOUR_OPERATORS.forEach(op => {
          try{
            localStorage.setItem(transfersStorageKey(op), JSON.stringify(transfersByOp[op] || []));
            localStorage.setItem(transfersStartKey(op), JSON.stringify(transfersStartByOp[op]));
          }catch{}
        });
      }, [transfersByOp, transfersStartByOp]);

const currentOp = activeOperator;
      const cols = currentOp ? columnsByOp[currentOp] : DEFAULT_COLUMNS;
      const rows = currentOp ? rowsByOp[currentOp] : [];



// Columns that should be compact numeric inputs (width follows header)
const numericKeys = React.useMemo(() => new Set(["aa", "hotel_total_beds"]), []);

      // Columns that should have width equal to header (compact), even if they are text
      const compactHeaderKeys = React.useMemo(() => new Set(["aa", "hotel_total_beds", "board"]), []);
// Sync numeric column widths to header widths (so numbers don't waste space)
React.useEffect(() => {
  if (!hotelsVisible) return;
  // defer to next paint so DOM sizes are correct
  const t = setTimeout(() => {
    try{
      const root = document.documentElement;
      const ths = Array.from(document.querySelectorAll("th[data-colkey]"));
      ths.forEach(th => {
        const key = th.getAttribute("data-colkey");
        if (!key) return;
        if (!compactHeaderKeys.has(key)) return;
        const w = th.getBoundingClientRect().width;
        // small safeguard so it doesn't become too tiny
        const w2 = Math.max(70, Math.min(220, Math.round(w)));
        root.style.setProperty(`--colw-${key}`, `${w2}px`);
      });
    }catch{}
  }, 0);
  return () => clearTimeout(t);
}, [hotelsVisible, cols, rows, currentOp, compactHeaderKeys]);

      const hotelsVisible = currentOp && hotelsOpen[currentOp];

// init default widths (user can resize freely after)
React.useEffect(() => {
  if (!currentOp) return;
  setColWidths(prev => {
    const next = { ...prev };
    (cols || []).forEach(c => {
      if (next[c.key] != null) return;
      if (DEFAULT_COLUMN_WIDTHS[c.key] != null) next[c.key] = DEFAULT_COLUMN_WIDTHS[c.key];
    });
    return next;
  });
}, [currentOp, cols]);



      const filteredRowIndices = React.useMemo(() => {
        if (!currentOp) return [];
        const q = (searchByOp[currentOp] || "").trim().toLowerCase();
        if (!q) return rows.map((_, idx) => idx);
        return rows.map((r, idx) => ({r, idx}))
          .filter(({r}) => (r.accomodation || "").toLowerCase().includes(q))
          .map(x => x.idx);
      }, [currentOp, rows, searchByOp]);

      const setCell = (rowIndex, colKey, value) => {
        setRowsByOp(prev => {
          const next = { ...prev };
          const copy = [...next[currentOp]];
          copy[rowIndex] = { ...copy[rowIndex], [colKey]: value };
          next[currentOp] = copy;
          return next;
        });
      };

      const addRow = () => {
        setRowsByOp(prev => {
          const next = { ...prev };
          next[currentOp] = normalizeHotelRows([ ...next[currentOp], emptyRow(cols) ]);
          return next;
        });
      };

      const addColumn = () => {
        const name = prompt("ÎŒÎ½Î¿Î¼Î± Î½Î­Î±Ï‚ ÏƒÏ„Î®Î»Î·Ï‚:");
        if (!name) return;

        const keyBase = name.toLowerCase().trim().replace(/\s+/g, "_").replace(/[^\w]/g, "") || "col";
        const key = keyBase + "_" + Math.random().toString(16).slice(2, 6);

        // Î Î‘ÎÎ¤Î‘ Î±Ï€Î»Î® text ÏƒÏ„Î®Î»Î· Î¼Îµ ÎšÎ•ÎÎ‘ ÎºÎµÎ»Î¹Î¬
        const type = "text";

        setColumnsByOp(prev => {
          const next = { ...prev };
          next[currentOp] = [...next[currentOp], { key, label: name, type }];
          return next;
        });

        setRowsByOp(prev => {
          const next = { ...prev };
          next[currentOp] = next[currentOp].map(r => ({ ...r, [key]: "" }));
          return next;
        });
      };

      const deleteSelectedRow = () => {
        const idx = selectedRowByOp[currentOp];
        if (idx == null) return;
        if (!confirm(`Î”Î¹Î±Î³ÏÎ±Ï†Î® Î³ÏÎ±Î¼Î¼Î®Ï‚ ${idx+1};`)) return;

        setRowsByOp(prev => {
          const next = { ...prev };
          next[currentOp] = normalizeHotelRows(next[currentOp].filter((_, i) => i !== idx));
          return next;
        });
        setSelectedRowByOp(prev => ({...prev, [currentOp]: null}));
      };

      const deleteSelectedCol = () => {
        const colKey = selectedColByOp[currentOp];
        if (!colKey) return;
        const col = cols.find(c => c.key === colKey);
        if (!col || col.type === "auto") return;
        if (!confirm(`Î”Î¹Î±Î³ÏÎ±Ï†Î® ÏƒÏ„Î®Î»Î·Ï‚ "${col.label}";`)) return;

        setColumnsByOp(prev => {
          const next = { ...prev };
          next[currentOp] = next[currentOp].filter(c => c.key !== colKey);
          return next;
        });

        setRowsByOp(prev => {
          const next = { ...prev };
          next[currentOp] = next[currentOp].map(r => {
            const nr = {...r};
            delete nr[colKey];
            return nr;
          });
          return next;
        });

        setSelectedColByOp(prev => ({...prev, [currentOp]: null}));
      };

      const clearAll = () => {
        if (!confirm("ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚ ÏŒÎ»Ï‰Î½ Ï„Ï‰Î½ Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ (Î¼ÏŒÎ½Î¿ Î³Î¹Î± Î±Ï…Ï„ÏŒÎ½ Ï„Î¿Î½ Tour Operator);")) return;
        setRowsByOp(prev => {
          const next = { ...prev };
          next[currentOp] = [emptyRow(cols), emptyRow(cols)];
          return next;
        });
        setSearchByOp(prev => ({...prev, [currentOp]: ""}));
        setSelectedRowByOp(prev => ({...prev, [currentOp]: null}));
        setSelectedColByOp(prev => ({...prev, [currentOp]: null}));
      };

      const exportFile = () => {
        const payload = {
          app: "Carpe Diem",
          type: "hotels",
          operator: currentOp,
          exportedAt: new Date().toISOString(),
          columns: columnsByOp[currentOp],
          rows: rowsByOp[currentOp],
        };
        const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `CarpeDiem_${currentOp}_Hotels.json`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(() => URL.revokeObjectURL(url), 1000);
      };

      const importFile = async (file) => {
        try{
          const text = await file.text();
          const parsed = JSON.parse(text);
          if (!parsed?.rows || !parsed?.columns) throw new Error("ÎœÎ· Î­Î³ÎºÏ…ÏÎ¿ Î±ÏÏ‡ÎµÎ¯Î¿ (Î»ÎµÎ¯Ï€Î¿Ï…Î½ columns/rows).");

          setColumnsByOp(prev => ({...prev, [currentOp]: parsed.columns}));
          setRowsByOp(prev => ({...prev, [currentOp]: normalizeHotelRows(parsed.rows)}));
          setSelectedRowByOp(prev => ({...prev, [currentOp]: null}));
          setSelectedColByOp(prev => ({...prev, [currentOp]: null}));
          alert("Î£Ï…Î³Ï‡ÏÎ¿Î½Î¹ÏƒÎ¼ÏŒÏ‚ Î¿Î»Î¿ÎºÎ»Î·ÏÏÎ¸Î·ÎºÎµ âœ…");
        }catch(e){
          alert("Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î± ÎµÎ¹ÏƒÎ±Î³Ï‰Î³Î®Ï‚: " + (e?.message || "Î¬Î³Î½Ï‰ÏƒÏ„Î¿ ÏƒÏ†Î¬Î»Î¼Î±"));
        }
      };

// ===== Excel Import (Hotels + Room table) =====
const normHeader = (s) => (s ?? "").toString().trim().toLowerCase().replace(/\s+/g, " ");
const firstTruthy = (...vals) => vals.find(v => v !== undefined && v !== null && v !== "");
const toNumberOrBlank = (v) => {
  if (v === null || v === undefined) return "";
  const n = Number(v);
  return Number.isFinite(n) ? n : "";
};


const normalizeHotelRows = (hotelRows) => (hotelRows || []).map((r, i) => ({
  ...(r || {}),
  aa: i + 1, // A/A depends ONLY on number of hotels
}));


const parseExcelToHotelRows = (sheetRows) => {
  if (!Array.isArray(sheetRows) || sheetRows.length < 2) return [];

  let headerRowIndex = -1;
  for (let i = 0; i < Math.min(sheetRows.length, 30); i++) {
    const row = sheetRows[i] || [];
    const headers = row.map(normHeader);
    if (headers.includes("accommodation") && (headers.includes("room types") || headers.includes("room type"))) {
      headerRowIndex = i;
      break;
    }
  }
  if (headerRowIndex === -1) throw new Error("Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ Î³ÏÎ±Î¼Î¼Î® headers (Î¸Î­Î»Ï‰ 'Accommodation' ÎºÎ±Î¹ 'Room types').");

  const header = (sheetRows[headerRowIndex] || []).map(normHeader);
  const col = (name) => header.indexOf(normHeader(name));

  const idxAA = firstTruthy(col("a/a"), col("aa"), col("a.a"));
  const idxAcc = firstTruthy(col("accommodation"), col("accomodation"));
  const idxBoard = col("board");
  const idxStars = col("stars");
  const idxRoom = firstTruthy(col("room types"), col("room type"));
  const idxAlloc = firstTruthy(col("allocation"), col("aloocation"), col("alocation"));
  const idxMinPax = firstTruthy(col("min pax"), col("minpax"));
  const idxMaxPax = firstTruthy(col("max pax"), col("maxpax"));
  const idxTotMinBeds = firstTruthy(col("total min beds"), col("total min bed"));
  const idxTotMaxBeds = firstTruthy(col("total max beds"), col("total max bed"));
  const idxCity = firstTruthy(col("location"), col("city"));
  const idxEmail = col("email");
  const idxPhone = col("phone");
  const idxWebsite = col("website");

  const hotels = [];
  let current = null;

  for (let r = headerRowIndex + 1; r < sheetRows.length; r++) {
    const row = sheetRows[r] || [];
    const aaVal = idxAA >= 0 ? row[idxAA] : null;
    const isNewHotel = Number.isFinite(Number(aaVal)) && (idxAcc >= 0 ? row[idxAcc] : null);

    if (isNewHotel) {
      if (current) hotels.push(current);

      current = {
        aa: Number(aaVal),
        accomodation: idxAcc >= 0 ? (row[idxAcc] ?? "") : "",
        board: idxBoard >= 0 ? (row[idxBoard] ?? "") : "",
        stars: idxStars >= 0 ? (row[idxStars] ?? "") : "",
        city: idxCity >= 0 ? (row[idxCity] ?? "") : "",
        email: idxEmail >= 0 ? (row[idxEmail] ?? "") : "",
        phone: idxPhone >= 0 ? (row[idxPhone] ?? "") : "",
        website: idxWebsite >= 0 ? (row[idxWebsite] ?? "") : "",
        roomTable: { columns: [...ROOM_TABLE_DEFAULT_COLS], rows: [] },
      };
    }

    if (current && idxRoom >= 0) {
      const roomType = row[idxRoom];
      if (roomType !== null && roomType !== undefined && roomType !== "") {
        current.roomTable.rows.push({
          room_types: roomType ?? "",
          allocation: idxAlloc >= 0 ? (row[idxAlloc] ?? "") : "",
          min_pax: idxMinPax >= 0 ? toNumberOrBlank(row[idxMinPax]) : "",
          max_pax: idxMaxPax >= 0 ? toNumberOrBlank(row[idxMaxPax]) : "",
          total_min_beds: idxTotMinBeds >= 0 ? toNumberOrBlank(row[idxTotMinBeds]) : "",
          total_max_beds: idxTotMaxBeds >= 0 ? toNumberOrBlank(row[idxTotMaxBeds]) : "",
        });
      }
    }
  }

  if (current) hotels.push(current);

  return hotels.map(h => {
    const rows = [...(h.roomTable?.rows || [])];
    while (rows.length < 10) {
      const blank = {};
      ROOM_TABLE_DEFAULT_COLS.forEach(c => (blank[c.key] = ""));
      rows.push(blank);
    }
    const roomTable = { columns: [...ROOM_TABLE_DEFAULT_COLS], rows };
    const totalBeds = recalcTotalHotelBeds(roomTable);
    return { ...h, roomTable, hotel_total_beds: totalBeds };
  });
};

const excelImport = async (file) => {
  if (!file) return;
  if (!window.XLSX) throw new Error("Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ Î· Î²Î¹Î²Î»Î¹Î¿Î¸Î®ÎºÎ· XLSX (SheetJS).");

  const buffer = await file.arrayBuffer();
  const wb = window.XLSX.read(buffer, { type: "array" });
  const sheetName = wb.SheetNames?.[0];
  if (!sheetName) throw new Error("Î¤Î¿ excel Î´ÎµÎ½ Î­Ï‡ÎµÎ¹ sheets.");

  const ws = wb.Sheets[sheetName];
  const data = window.XLSX.utils.sheet_to_json(ws, { header: 1, raw: true });

  const hotelRows = normalizeHotelRows(parseExcelToHotelRows(data));

  if (!currentOp) throw new Error("Î”ÎµÎ½ Î­Ï‡ÎµÎ¹ ÎµÏ€Î¹Î»ÎµÎ³ÎµÎ¯ Tour Operator.");
  setRowsByOp(prev => ({ ...prev, [currentOp]: hotelRows }));
  setSearchByOp(prev => ({ ...prev, [currentOp]: "" }));
  setSelectedRowByOp(prev => ({ ...prev, [currentOp]: null }));
  setSelectedColByOp(prev => ({ ...prev, [currentOp]: null }));

  alert("Excel ÎµÎ¹ÏƒÎ®Ï‡Î¸Î· ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚ âœ… (" + hotelRows.length + " Î¾ÎµÎ½Î¿Î´Î¿Ï‡ÎµÎ¯Î±)");
};
      // (removed) onSyncClick prompt-based sync

      const toggleOperator = (op) => {
        setTourOpen(true);
        setActiveSection("Tour Operator");
        setActiveOperator(op);
        setOpOpen(prev => ({...prev, [op]: !prev[op]}));
      };

      const toggleHotels = (op) => {
        setTourOpen(true);
        setActiveSection("Tour Operator");
        setActiveOperator(op);
        setHotelsOpen(prev => ({...prev, [op]: !prev[op]}));
        setSelectedRowByOp(prev => ({...prev, [op]: null}));
        setSelectedColByOp(prev => ({...prev, [op]: null}));
      };


const toggleTransfers = (op) => {
  setTourOpen(true);
  setActiveSection("Transfers");
  setActiveOperator(op);
  setTransfersOpen(prev => ({...prev, [op]: !prev[op]}));
  setSelectedRowByOp(prev => ({...prev, [op]: null}));
  setSelectedColByOp(prev => ({...prev, [op]: null}));
};


const toggleTasks = (op) => {
  setTourOpen(true);
  setActiveSection("Tasks");
  setActiveOperator(op);
  setTasksOpen(prev => ({...prev, [op]: !prev[op]}));
  setSelectedRowByOp(prev => ({...prev, [op]: null}));
  setSelectedColByOp(prev => ({...prev, [op]: null}));
};


const transfersVisible = currentOp && transfersOpen[currentOp];

const toISO = (d) => {
  const x = new Date(d);
  x.setHours(0,0,0,0);
  const pad = (n) => String(n).padStart(2,"0");
  return `${x.getFullYear()}-${pad(x.getMonth()+1)}-${pad(x.getDate())}`;
};
const addDaysISO = (iso, delta) => {
  const [y,m,dd] = (iso||todayISO()).split("-").map(Number);
  const d = new Date(y, (m||1)-1, dd||1);
  d.setDate(d.getDate() + delta);
  return toISO(d);
};
const formatDay = (iso) => {
  const [y,m,d] = (iso||"").split("-").map(Number);
  const dt = new Date(y, (m||1)-1, d||1);
  return dt.toLocaleDateString("el-GR", { weekday:"short", day:"2-digit", month:"2-digit" });
};

const ensureTransfersStart = React.useCallback((op) => {
  setTransfersStartByOp(prev => {
    if (prev?.[op]) return prev;
    return { ...prev, [op]: todayISO() };
  });
}, [todayISO]);

React.useEffect(() => {
  if (activeSection === "Transfers") document.title = "Transfers";
  else if (activeSection === "Tasks") document.title = "Tasks";
  else document.title = "Carpe Diem";
}, [activeSection]);

React.useEffect(() => {
  if (activeSection !== "Transfers" || !currentOp || !transfersOpen[currentOp]) return;
  ensureTransfersStart(currentOp);
}, [activeSection, currentOp, transfersOpen, ensureTransfersStart]);

const parseTransfersFile = async (file, op) => {
  const text = await file.text();

  const lines = (text || "")
    .split(/\r?\n/)
    .map(l => l.trim())
    .filter(Boolean);

  if (!lines.length) return [];

  const splitLine = (l) => {
    const sep = l.includes(";") ? ";" : (l.includes("\t") ? "\t" : ",");
    return l.split(sep).map(x => (x ?? "").toString().trim());
  };

  // ===== Column mapping (based on your rules + sample file) =====
  // 1  -> Date
  // 2  -> Flight number
  // 3  -> If NOT "EFL" => ARRIVAL, if "EFL" => DEPARTURE
  // 4  -> Time for DEPARTURE (shown inside chip)
  // 6  -> Time for ARRIVAL   (shown inside chip)
  // 9  -> Hotel name (we use parts[8])
  // 10 -> Area (we use parts[9]) -> used for grouping in left "Î”Î¹Î±Î´ÏÎ¿Î¼Î®" column
  // 13 -> Booking number (we use parts[12]) -> pax = how many lines share this booking number
  // last -> "Private Transfer" => private badge

  // 1) Parse rows to lightweight objects + booking id
  const rows = [];
  for (let i = 0; i < lines.length; i++) {
    const parts = splitLine(lines[i]);
    if (parts.length < 13) continue;

    const rawDate = (parts[0] || "").trim();
    const flight  = (parts[1] || "").trim();
    const col3    = (parts[2] || "").trim();
    const time4   = (parts[3] || "").trim();
    const time6   = (parts[5] || "").trim();
    const hotelRaw = (parts[8] || "").trim();
    const hotel    = sanitizeAccommodation(hotelRaw);
const area    = (parts[9] || "").trim();
    const booking = (parts[12] || "").trim();
    const last    = (parts[parts.length - 1] || "").trim();

    if (!booking) continue;

    // Date to ISO
    let dateISO = "";
    if (/^\d{4}-\d{2}-\d{2}$/.test(rawDate)) {
      dateISO = rawDate;
    } else if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(rawDate)) {
      const [d, m, y] = rawDate.split("/").map(Number);
      const pad = (n) => String(n).padStart(2, "0");
      dateISO = `${y}-${pad(m)}-${pad(d)}`;
    } else {
      const dt = new Date(rawDate);
      if (!isNaN(dt.getTime())) dateISO = toISO(dt);
    }
    if (!dateISO) continue;

    // Direction
    const code = (col3 || "").replace(/\s+/g, "").toUpperCase();
    const direction = (code === "EFL") ? "DEPARTURE" : "ARRIVAL";

    // Time (per your rule)
    const time = (direction === "ARRIVAL") ? time6 : time4;

    const isPrivate = /private\s*transfer/i.test(last);

    rows.push({
      booking,
      date: dateISO,
      direction,
      flight,
      time,
      hotel: hotel || "â€”",
      area: area || "â€”",
      isPrivate,
    });
  }

  if (!rows.length) return [];

  // 2) pax per booking number = how many lines share same booking
  const paxByBooking = new Map();
  rows.forEach(r => {
    paxByBooking.set(r.booking, (paxByBooking.get(r.booking) || 0) + 1);
  });

  // 3) Reduce to ONE record per booking (to avoid double-counting in next aggregation)
  const bookingRecord = new Map();
  rows.forEach(r => {
    if (!bookingRecord.has(r.booking)) bookingRecord.set(r.booking, r);
  });

  // 4) Aggregate for calendar display:
  // If same Hotel AND same Flight (and same date+direction+time+area), show ONE chip with pax = sum pax.
  const agg = new Map();
  bookingRecord.forEach((r, bookingId) => {
    const pax = paxByBooking.get(bookingId) || 1;

    const key = [
      r.date,
      r.direction,
      r.flight,
      r.hotel,
      r.area,
      r.time,
      r.isPrivate ? "P" : "S",
    ].join("||");

    const prev = agg.get(key);
    if (!prev) {
      agg.set(key, {
        id: `${op}_${Date.now()}_${Math.random().toString(16).slice(2)}`,
        operator: op,
        date: r.date,
        direction: r.direction,
        area: r.area,
        hotel: r.hotel,
        pax: pax,
        time: r.time,
        flight: r.flight,
        isPrivate: r.isPrivate,
      });
    } else {
      prev.pax = (Number(prev.pax) || 0) + pax;
    }
  });

  return Array.from(agg.values());
};

const importTransfers = async (file) => {
  if (!currentOp || !file) return;
  try{
    const items = await parseTransfersFile(file, currentOp);
    if (!items.length){
      setTransfersStatusByOp(prev => ({ ...prev, [currentOp]: "Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ ÎµÎ³Î³ÏÎ±Ï†Î­Ï‚ ÏƒÏ„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿" }));
      return;
    }
    setTransfersByOp(prev => ({ ...prev, [currentOp]: [ ...(prev[currentOp] || []), ...items ] }));
    setTransfersStatusByOp(prev => ({ ...prev, [currentOp]: `Î•Î¹ÏƒÎ®Ï‡Î¸Î·ÏƒÎ±Î½ ${items.length} ÎµÎ³Î³ÏÎ±Ï†Î­Ï‚` }));
  }catch(e){
    setTransfersStatusByOp(prev => ({ ...prev, [currentOp]: "Î£Ï†Î¬Î»Î¼Î± import" }));
    alert("Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î± import transfers: " + (e?.message || "Î¬Î³Î½Ï‰ÏƒÏ„Î¿ ÏƒÏ†Î¬Î»Î¼Î±"));
  }
};

const clearAllTransfers = () => {
  if (!currentOp) return;
  if (!confirm("Î”Î¹Î±Î³ÏÎ±Ï†Î® ÏŒÎ»Ï‰Î½ Ï„Ï‰Î½ transfers Î³Î¹Î± Î±Ï…Ï„ÏŒÎ½ Ï„Î¿Î½ Tour Operator;")) return;
  setTransfersByOp(prev => ({ ...prev, [currentOp]: [] }));
  setTransfersStatusByOp(prev => ({ ...prev, [currentOp]: "Î”Î¹Î±Î³ÏÎ¬Ï†Î·ÎºÎ±Î½ ÏŒÎ»Î±" }));
};

const startResize = (e, colKey) => {
  e.preventDefault();
  e.stopPropagation();

  const th = e.currentTarget?.parentElement;
  const startX = e.clientX;
  const startWidth = colWidths[colKey] ?? (th ? th.getBoundingClientRect().width : 100);

  const onMove = (ev) => {
    const newWidth = Math.max(32, Math.round(startWidth + (ev.clientX - startX)));
    setColWidths(w => ({ ...w, [colKey]: newWidth }));
  };

  const onUp = () => {
    document.removeEventListener("mousemove", onMove);
    document.removeEventListener("mouseup", onUp);
  };

  document.addEventListener("mousemove", onMove);
  document.addEventListener("mouseup", onUp);
};



      const renderCell = (rowIndex, col) => {
        if (col.type === "auto"){
  return (
    <div className="flex items-center justify-between gap-2">
      <span className="text-white/80 tabular-nums">{rowIndex+1}</span>
      <button
        className="btn btn-ghost rounded-lg px-2 py-1 text-[11px]"
        title="Î†Î½Î¿Î¹Î³Î¼Î± Ï†ÏŒÏÎ¼Î±Ï‚"
        onClick={(e) => { e.stopPropagation(); openRowForm(rowIndex); }}
      >
        Î¦ÏŒÏÎ¼Î±
      </button>
    </div>
  );
}
        if (col.type === "check"){
          return (
            <div className="flex items-center justify-center">
              <input
                className="checkbox"
                type="checkbox"
                checked={!!rows[rowIndex]?.[col.key]}
                onChange={(e) => setCell(rowIndex, col.key, e.target.checked)}
              />
            </div>
          );
        }
        
  return (
    <input
      className={numericKeys.has(col.key) ? "cell num" : "cell"}
      type={numericKeys.has(col.key) ? "number" : "text"}
      inputMode={numericKeys.has(col.key) ? "numeric" : undefined}
      style={numericKeys.has(col.key) ? { width: `var(--colw-${col.key}, 90px)` } : undefined}
      value={rows[rowIndex]?.[col.key] ?? ""}
      onChange={(e) =>
        setCell(
          rowIndex,
          col.key,
          col.key === "accomodation"
            ? sanitizeAccommodation(e.target.value)
            : e.target.value
        )
      }
      title={rows[rowIndex]?.[col.key] ?? ""}
    />
  );
};



      return (
        <div className="h-screen w-screen flex gap-2 p-3">
          {/* Sidebar */}
          <aside className="w-[280px] panel-strong p-3 flex flex-col overflow-hidden">
            <div className="flex items-center justify-between pb-2">
              <div>
                <div className="text-[15px] font-extrabold tracking-tight">Carpe Diem</div>
                <div className="text-[11px] muted">Office Database</div>
              </div>
              <span className="pill">v8</span>
            </div>

            <div className="divider my-2"></div>

            <div className="pt-1 flex-1 overflow-auto scrollbar">

              {/* Main Calendar */}
              <button
                className={"btn w-full rounded-xl px-3 py-2 flex items-center justify-between mb-2 " +
                  (activeSection==="Main Calendar" ? "opacity-100" : "opacity-90")}
                onClick={() => { setActiveSection("Main Calendar"); setTourOpen(false); }}
              >
                <span className="font-semibold text-[13px]">Main Calendar</span>
              </button>

              {/* Tour Operator */}
              <button
                className="btn w-full rounded-xl px-3 py-2 flex items-center justify-between"
                onClick={() => { setActiveSection("Tour Operator"); setTourOpen(v => !v); }}
              >
                <span className="font-semibold text-[13px]">Tour Operator</span>
                <IconChevron open={tourOpen} />
              </button>

              {tourOpen && (
                <div className="mt-2 ml-2 space-y-2">
                  {TOUR_OPERATORS.map(op => (
                    <div key={op}>
                      <button
                        className={"btn w-full rounded-xl px-3 py-2 flex items-center justify-between " +
                          (activeOperator===op ? "opacity-100" : "opacity-90")}
                        onClick={() => toggleOperator(op)}
                      >
                        <span className="font-semibold text-[13px]">{op}</span>
                        <IconChevron open={!!opOpen[op]} />
                      </button>

                      {opOpen[op] && (
                        <div className="ml-3 mt-1 space-y-1">
                          <button
                            className={"btn w-full rounded-xl px-3 py-1.5 flex items-center justify-between " +
                              (hotelsOpen[op] ? "opacity-100" : "opacity-90")}
                            onClick={() => toggleHotels(op)}
                          >
                            <span className="text-[12px] font-semibold">Hotels</span>
                            <IconChevron open={!!hotelsOpen[op]} />
                          </button>

                          <button
                            className={"btn w-full rounded-xl px-3 py-1.5 flex items-center justify-between " +
                              (transfersOpen[op] ? "opacity-100" : "opacity-90")}
                            onClick={() => toggleTransfers(op)}
                          >
                            <span className="text-[12px] font-semibold">Transfers</span>
                            <IconChevron open={!!transfersOpen[op]} />
                          </button>

                          <button
                            className={"btn w-full rounded-xl px-3 py-1.5 flex items-center justify-between " +
                              (tasksOpen[op] ? "opacity-100" : "opacity-90")}
                            onClick={() => toggleTasks(op)}
                          >
                            <span className="text-[12px] font-semibold">Tasks</span>
                            <IconChevron open={!!tasksOpen[op]} />
                          </button>
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              )}

              <div className="divider my-3"></div>

{/* Task */}
              <button
                className={"btn w-full rounded-xl px-3 py-2 flex items-center justify-between " +
                  (activeSection==="Task" ? "opacity-100" : "opacity-90")}
                onClick={() => setActiveSection("Task")}
              >
                <span className="font-semibold text-[13px]">Task</span>
              </button>

              {/* Transfers/Tours */}
              <button
                className={"btn w-full rounded-xl px-3 py-2 flex items-center justify-between mt-2 " +
                  (activeSection==="Transfers/Tours" ? "opacity-100" : "opacity-90")}
                onClick={() => { setTtOpen(v => !v); }}
              >
                <span className="font-semibold text-[13px]">Transfers/Tours</span>
                <IconChevron open={ttOpen} />
              </button>

              {ttOpen && (
                <div className="mt-2 ml-2 space-y-2">
                  <button
                    className={"btn w-full rounded-xl px-3 py-1.5 flex items-center justify-between " +
                      (ttTab==="Transfer" ? "opacity-100" : "opacity-90")}
                    onClick={() => { setActiveSection("Transfers/Tours"); setTtTab("Transfer"); }}
                  >
                    <span className="text-[12px] font-semibold">Transfer</span>
                    <span className="pill">All</span>
                  </button>

                  <button
                    className={"btn w-full rounded-xl px-3 py-1.5 flex items-center justify-between " +
                      (ttTab==="Tours" ? "opacity-100" : "opacity-90")}
                    onClick={() => { setActiveSection("Transfers/Tours"); setTtTab("Tours"); }}
                  >
                    <span className="text-[12px] font-semibold">Tours</span>
                    <span className="pill">Soon</span>
                  </button>
                </div>
              )}
            </div>

            <div className="divider my-2"></div>

            <div className="text-[11px] muted flex items-center justify-between">
              <span>Autosave</span>
              <span className="pill">browser</span>
            </div>
          </aside>

          {/* Main */}
          <main className="flex-1 panel-strong overflow-hidden flex flex-col">
            <header className="px-4 py-3 flex items-center justify-between">
              <div>
                <div className="text-[15px] font-extrabold tracking-tight">
                  {activeSection === "Tour Operator"
                    ? <>Tour Operator <span className="muted font-semibold">/ {currentOp ? currentOp : "â€”"} {hotelsVisible ? "/ Hotels" : ""}</span></>
                    : activeSection === "Main Calendar"
                      ? <>Main Calendar</>
                    : activeSection === "Transfers"
                      ? <>Transfers <span className="muted font-semibold">/ {currentOp ? currentOp : "â€”"}</span></>
                      : activeSection === "Tasks"
                        ? <>Tasks <span className="muted font-semibold">/ {currentOp ? currentOp : "â€”"}</span></>
                      : activeSection === "Transfers/Tours"
                        ? <>Transfers/Tours <span className="muted font-semibold">/ {ttTab}</span></>
                        : <>{activeSection} <span className="muted font-semibold">/ (coming soon)</span></>
                  }
                </div>
                <div className="text-[11px] muted mt-0.5">
                  Expand: Tour Operator â–¸ operator â–¸ Hotels
                </div>
              </div>
              {currentOp && <span className="pill">Operator: <b className="text-white/90">{currentOp}</b></span>}
            </header>

            <div className="divider"></div>

            <div className="flex-1 overflow-hidden p-3">
              {activeSection === "Main Calendar" ? (
                <MainCalendar />
              ) : activeSection === "Transfers" ? (
                <div id="viewTransfers" className="h-full flex flex-col">
                  {!currentOp || !transfersVisible ? (
                    <div className="panel p-5 text-white/75">
                      Î•Ï€Î­Î»ÎµÎ¾Îµ: <b>Tour Operator</b> â†’ Î­Î½Î±Î½ operator â†’ <b>Transfers</b>.
                    </div>
                  ) : (
                    (() => {
                      const startISO = transfersStartByOp[currentOp] || todayISO();
                      const days = Array.from({ length: 30 }, (_, i) => addDaysISO(startISO, i));

                      const all = transfersByOp[currentOp] || [];
                      const inWindow = all.filter(t => t?.date >= startISO && t?.date <= days[days.length-1]);

                      const byDir = (dir) => inWindow.filter(t => t.direction === dir);
                      const groupByArea = (arr) => {
                        const m = new Map();
                        arr.forEach(t => {
                          const key = (t.area || "â€”").trim() || "â€”";
                          if (!m.has(key)) m.set(key, []);
                          m.get(key).push(t);
                        });
                        return Array.from(m.entries()).sort((a,b) => a[0].localeCompare(b[0], "el"));
                      };

                      const arrivalsByArea = groupByArea(byDir("ARRIVAL"));
                      const depsByArea = groupByArea(byDir("DEPARTURE"));

                      const areaTotalPax = (items) => items.reduce((s,x)=> s + (Number(x.pax)||0), 0);
                      const cellItems = (items, dateISO) => items
                        .filter(t => t.date === dateISO)
                        .sort((a,b) => (a.time||"").localeCompare(b.time||""));

                      const onPrev = () => setTransfersStartByOp(prev => ({ ...prev, [currentOp]: addDaysISO(startISO, -1) }));
                      const onNext = () => setTransfersStartByOp(prev => ({ ...prev, [currentOp]: addDaysISO(startISO, +1) }));
                      const onToday = () => setTransfersStartByOp(prev => ({ ...prev, [currentOp]: todayISO() }));

                      return (
                        <>
                          <div className="panel p-2 mb-2">
                            <div className="flex flex-wrap gap-2 items-center">
                              <button className="btn rounded-xl px-3 py-1.5 text-[12px]" onClick={onPrev}>â† Î ÏÎ¿Î·Î³Î¿ÏÎ¼ÎµÎ½Î· Î·Î¼Î­ÏÎ±</button>
                              <button className="btn rounded-xl px-3 py-1.5 text-[12px]" onClick={onToday}>Î£Î®Î¼ÎµÏÎ±</button>
                              <button className="btn rounded-xl px-3 py-1.5 text-[12px]" onClick={onNext}>Î•Ï€ÏŒÎ¼ÎµÎ½Î· Î·Î¼Î­ÏÎ± â†’</button>

                              <div className="flex items-center gap-2 ml-1">
                                <input id="transfersDatePick" className="cell dark-date-input" type="date" defaultValue={startISO} style={{ maxWidth: 170 }} />
                                <button
                                  className="btn rounded-xl px-3 py-1.5 text-[12px]"
                                  onClick={() => {
                                    const v = document.getElementById("transfersDatePick")?.value;
                                    if (v) setTransfersStartByOp(prev => ({ ...prev, [currentOp]: v }));
                                  }}
                                >ÎœÎµÏ„Î¬Î²Î±ÏƒÎ·</button>
                              </div>

                              <button className="btn rounded-xl px-3 py-1.5 text-[12px]" onClick={() => transfersFileRef.current?.click()}>
                                â¤“ Î£Ï…Î³Ï‡ÏÎ¿Î½Î¹ÏƒÎ¼ÏŒÏ‚ Î±ÏÏ‡ÎµÎ¯Î¿Ï…
                              </button>
                              <input
                                ref={transfersFileRef}
                                type="file"
                                accept=".txt,.rtf,.csv,text/plain,text/csv,application/rtf"
                                className="hidden"
                                onChange={async (e) => {
                                  const f = e.target.files?.[0];
                                  e.target.value = "";
                                  if (f) await importTransfers(f);
                                }}
                              />

                              <button className="btn rounded-xl px-3 py-1.5 text-[12px]" onClick={clearAllTransfers}>
                                Î”Î¹Î±Î³ÏÎ±Ï†Î® ÏŒÎ»Ï‰Î½
                              </button>

                              <span className="t-status ml-auto">
                                <span className="pill">Start: <b className="text-white/90">{startISO}</b></span>
                                <span className="pill">{transfersStatusByOp[currentOp] || "â€”"}</span>
                              </span>
                            </div>

                            <div className="text-[11px] muted mt-2 flex flex-wrap gap-2 items-center">
                              <span className="pill">Î Î±ÏÎ¬Î¸Ï…ÏÎ¿: <b className="text-white/85">30 Î·Î¼Î­ÏÎµÏ‚</b></span>
                              <span className="pill">Î•Î³Î³ÏÎ±Ï†Î­Ï‚ ÏƒÏ„Î¿ Ï€Î±ÏÎ¬Î¸Ï…ÏÎ¿: <b className="text-white/85">{inWindow.length}</b></span>
                              <span className="pill">Î”Î¹Ï€Î»ÏŒ ÎºÎ»Î¹Îº ÏƒÎµ <b className="text-white/85">Private</b> chip â†’ details</span>
                            </div>
                          </div>

                          <div className="transfers-wrap panel scrollbar">
                            <table>
                              <thead>
                                <tr>
                                  <th className="rownum-th" style={{ minWidth: 260, left: 0, position:"sticky", zIndex: 12 }}>
                                    Î”Î¹Î±Î´ÏÎ¿Î¼Î®
                                  </th>
                                  {days.map(d => (
                                    <th key={d} title={d}>
                                      {formatDay(d)}
                                      <div className="muted text-[10px] mt-0.5">{d}</div>
                                    </th>
                                  ))}
                                </tr>
                              </thead>

                              <tbody>
                                <tr className="t-section-row">
                                  <td className="rownum" style={{ position:"sticky", left:0, zIndex: 11 }}>
                                    Î‘Î¦Î™ÎÎ•Î™Î£ <span className="muted font-semibold">(Airport â†’ Î ÎµÏÎ¹Î¿Ï‡Î®)</span>
                                  </td>
                                  <td colSpan={days.length}></td>
                                </tr>

                                {arrivalsByArea.length === 0 ? (
                                  <tr>
                                    <td className="rownum muted" style={{ position:"sticky", left:0, zIndex: 11 }}>
                                      â€” Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î±Ï†Î¯Î¾ÎµÎ¹Ï‚ ÏƒÏ„Î¿ Ï€Î±ÏÎ¬Î¸Ï…ÏÎ¿ â€”
                                    </td>
                                    <td colSpan={days.length}></td>
                                  </tr>
                                ) : (
                                  arrivalsByArea.map(([area, items]) => {
                                    const total = areaTotalPax(items);

                                    // Build slot-rows: one booking per row, so left cell height matches content
                                    const byDate = Object.fromEntries(days.map(d => [d, cellItems(items, d)]));
                                    const maxSlots = Math.max(1, ...days.map(d => (byDate[d] || []).length));
                                    const slots = Array.from({ length: maxSlots }, (_, slotIdx) =>
                                      Object.fromEntries(days.map(d => [d, (byDate[d] || [])[slotIdx] || null]))
                                    );

                                    const renderChip = (t) => (
                                      <span
                                        key={t.id}
                                        className="t-chip"
                                        onDoubleClick={() => {
                                          if (t.isPrivate) setPrivateModal({ open:true, item:t });
                                        }}
                                        title={[
                                          t.operator,
                                          t.hotel,
                                          `${t.pax||0} pax`,
                                          t.time ? `@ ${t.time}` : "",
                                          t.flight ? `Flight ${t.flight}` : ""
                                        ].filter(Boolean).join(" â€¢ ")}
                                      >
                                        <span className={`op-pill ${operatorClass(t.operator)}`}>{t.operator}</span>
                                        <span className="font-semibold">{t.hotel || "â€”"}</span>
                                        <span className="pill">{t.pax || 0} pax</span>
                                        {(t.time || t.flight) && (
                                          <span className="muted">
                                            {t.time ? t.time : ""}{t.time && t.flight ? " Â· " : ""}{t.flight ? t.flight : ""}
                                          </span>
                                        )}
                                        {t.isPrivate && <span className="t-badge private">Private</span>}
                                      </span>
                                    );


                                    return (
                                      <React.Fragment key={"A_"+area}>
                                        {slots.map((slot, slotIdx) => (
                                          <tr key={"A_"+area+"_"+slotIdx}>
                                            {slotIdx === 0 && (
                                              <td className="rownum" rowSpan={slots.length} style={{ position:"sticky", left:0, zIndex: 11 }}>
                                                <div className="font-extrabold">{area}</div>
                                                <div className="t-area-total">Î£ÏÎ½Î¿Î»Î¿: {total} pax</div>
                                              </td>
                                            )}
                                            {days.map(d => (
                                              <td key={area+"_"+d+"_"+slotIdx}>
                                                <div className="t-cell">{slot[d] ? renderChip(slot[d]) : null}</div>
                                              </td>
                                            ))}
                                          </tr>
                                        ))}
                                      </React.Fragment>
                                    );
                                  })
                                )}<tr className="t-section-row">
                                  <td className="rownum" style={{ position:"sticky", left:0, zIndex: 11 }}>
                                    Î‘ÎÎ‘Î§Î©Î¡Î—Î£Î•Î™Î£ <span className="muted font-semibold">(Î ÎµÏÎ¹Î¿Ï‡Î® â†’ Airport)</span>
                                  </td>
                                  <td colSpan={days.length}></td>
                                </tr>

                                {depsByArea.length === 0 ? (
                                  <tr>
                                    <td className="rownum muted" style={{ position:"sticky", left:0, zIndex: 11 }}>
                                      â€” Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î±Î½Î±Ï‡Ï‰ÏÎ®ÏƒÎµÎ¹Ï‚ ÏƒÏ„Î¿ Ï€Î±ÏÎ¬Î¸Ï…ÏÎ¿ â€”
                                    </td>
                                    <td colSpan={days.length}></td>
                                  </tr>
                                ) : (
                                  depsByArea.map(([area, items]) => {
                                    const total = areaTotalPax(items);

                                    const byDate = Object.fromEntries(days.map(d => [d, cellItems(items, d)]));
                                    const maxSlots = Math.max(1, ...days.map(d => (byDate[d] || []).length));
                                    const slots = Array.from({ length: maxSlots }, (_, slotIdx) =>
                                      Object.fromEntries(days.map(d => [d, (byDate[d] || [])[slotIdx] || null]))
                                    );

                                    const renderChip = (t) => (
                                      <span
                                        key={t.id}
                                        className="t-chip"
                                        onDoubleClick={() => {t.isPrivate && <span className="t-badge private">Private</span>}}
                                        title={[
                                          t.operator,
                                          t.hotel,
                                          `${t.pax||0} pax`,
                                          t.time ? `@ ${t.time}` : "",
                                          t.flight ? `Flight ${t.flight}` : ""
                                        ].filter(Boolean).join(" â€¢ ")}
                                      >
                                        <span className="t-badge">{t.operator}</span>
                                        <span className="font-semibold">{t.hotel || "â€”"}</span>
                                        <span className="pill">{t.pax || 0} pax</span>
                                        {(t.time || t.flight) && (
                                          <span className="muted">
                                            {t.time ? t.time : ""}{t.time && t.flight ? " Â· " : ""}{t.flight ? t.flight : ""}
                                          </span>
                                        )}
                                        {t.isPrivate && <span className="t-badge private">Private</span>}
                                      </span>
                                    );

                                    return (
                                      <React.Fragment key={"D_"+area}>
                                        {slots.map((slot, slotIdx) => (
                                          <tr key={"D_"+area+"_"+slotIdx}>
                                            {slotIdx === 0 && (
                                              <td className="rownum" rowSpan={slots.length} style={{ position:"sticky", left:0, zIndex: 11 }}>
                                                <div className="font-extrabold">{area}</div>
                                                <div className="t-area-total">Î£ÏÎ½Î¿Î»Î¿: {total} pax</div>
                                              </td>
                                            )}
                                            {days.map(d => (
                                              <td key={area+"_"+d+"_"+slotIdx}>
                                                <div className="t-cell">{slot[d] ? renderChip(slot[d]) : null}</div>
                                              </td>
                                            ))}
                                          </tr>
                                        ))}
                                      </React.Fragment>
                                    );
                                  })
                                )}</tbody>
                            </table>
                          </div>

                          {privateModal.open && privateModal.item && (
                            <div className="tmodal-overlay" onClick={() => setPrivateModal({ open:false, item:null })}>
                              <div className="tmodal" onClick={(e) => e.stopPropagation()}>
                                <div className="flex items-start justify-between gap-3">
                                  <div>
                                    <h3>Private Transfer (read-only)</h3>
                                    <div className="muted text-[11px]">Î”Î¹Ï€Î»ÏŒ ÎºÎ»Î¹Îº Î¬Î½Î¿Î¹Î¾Îµ Î»ÎµÏ€Ï„Î¿Î¼Î­ÏÎµÎ¹ÎµÏ‚</div>
                                  </div>
                                  <button className="btn rounded-xl px-3 py-1.5 text-[12px]" onClick={() => setPrivateModal({ open:false, item:null })}>
                                    ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿
                                  </button>
                                </div>
                                <div className="divider my-3"></div>
                                <div className="kv">
                                  <div className="k">Operator</div><div className="v">{privateModal.item.operator}</div>
                                  <div className="k">Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±</div><div className="v">{privateModal.item.date}</div>
                                  <div className="k">Î¤ÏÏ€Î¿Ï‚</div><div className="v">{privateModal.item.direction === "ARRIVAL" ? "Î†Ï†Î¹Î¾Î·" : "Î‘Î½Î±Ï‡ÏÏÎ·ÏƒÎ·"}</div>
                                  <div className="k">Î ÎµÏÎ¹Î¿Ï‡Î®</div><div className="v">{privateModal.item.area || "â€”"}</div>
                                  <div className="k">Hotel</div><div className="v">{privateModal.item.hotel || "â€”"}</div>
                                  <div className="k">Pax</div><div className="v">{privateModal.item.pax || 0}</div>
                                  <div className="k">ÎÏÎ±</div><div className="v">{privateModal.item.time || "â€”"}</div>
                                  <div className="k">Î Ï„Î®ÏƒÎ·</div><div className="v">{privateModal.item.flight || "â€”"}</div>
                                  <div className="k">Private</div><div className="v">ÎÎ±Î¹</div>
                                </div>
                              </div>
                            </div>
                          )}
                        </>
                      );
                    })()
                  )}
                </div>
              ) : (activeSection === "Tasks") ? (
                <div id="viewTasks" className="h-full flex flex-col">
                  {!currentOp || !tasksOpen[currentOp] ? (
                    <div className="panel p-5 text-white/75">
                      Î•Ï€Î­Î»ÎµÎ¾Îµ: <b>Tour Operator</b> â†’ Î­Î½Î±Î½ operator â†’ <b>Tasks</b>.
                    </div>
                  ) : (
                    <TasksTimeline operator={currentOp} />
                  )}
                </div>
              
              ) : (activeSection === "Task") ? (
                <div id="viewTaskSoon" className="h-full flex flex-col">
                  <AllOperatorsTasksTimeline />
                </div>
) : (activeSection !== "Tour Operator" && activeSection !== "Transfers/Tours") ? (
                <div className="panel p-5 text-white/75">
                  Î¤Î¿ module <b>{activeSection}</b> Î¸Î± Ï€ÏÎ¿ÏƒÏ„ÎµÎ¸ÎµÎ¯ Î¼ÎµÏ„Î¬.
                </div>
              ) : (activeSection === "Transfers/Tours") ? (
                <div id="viewTransfersTours" className="h-full flex flex-col">
                  <div className="panel p-2 mb-2">
                    <div className="flex flex-wrap gap-2 items-center">
                      <button
                        className={"btn rounded-xl px-3 py-1.5 text-[12px] " + (ttTab==="Transfer" ? "opacity-100" : "opacity-90")}
                        onClick={() => setTtTab("Transfer")}
                      >
                        Transfer
                      </button>
                      <button
                        className={"btn rounded-xl px-3 py-1.5 text-[12px] " + (ttTab==="Tours" ? "opacity-100" : "opacity-90")}
                        onClick={() => setTtTab("Tours")}
                      >
                        Tours
                      </button>

                      <span className="pill ml-auto">Î£Ï…Î³ÎºÎµÎ½Ï„ÏÏ‰Ï„Î¹ÎºÏŒ</span>
                    </div>
                  </div>

                  {ttTab !== "Transfer" ? (
                    <div className="panel p-5 text-white/75">Coming soonâ€¦</div>
                  ) : (
                    (() => {
                      const startISO = ttStartISO || todayISO();
                      const days = Array.from({ length: 30 }, (_, i) => addDaysISO(startISO, i));

                      // Gather ALL transfers from ALL tour operators (same data as each operator calendar)
                      const all = TOUR_OPERATORS.flatMap(op => (transfersByOp[op] || []).map(t => ({ ...t, __op: op })));
                      const inWindow = all.filter(t => t?.date >= startISO && t?.date <= days[days.length-1]);

                      const byDir = (dir) => inWindow.filter(t => t.direction === dir);

                      const groupByArea = (arr) => {
                        const m = new Map();
                        arr.forEach(t => {
                          const key = (t.area || "â€”").trim() || "â€”";
                          if (!m.has(key)) m.set(key, []);
                          m.get(key).push(t);
                        });
                        return Array.from(m.entries()).sort((a,b) => a[0].localeCompare(b[0], "el"));
                      };

                      const areaTotalPax = (items) => items.reduce((s,x)=> s + (Number(x.pax)||0), 0);

                      const cellItems = (items, dateISO) => items
                        .filter(t => t.date === dateISO)
                        .sort((a,b) => (a.time||"").localeCompare(b.time||""));

                      const onPrev = () => setTtStartISO(addDaysISO(startISO, -1));
                      const onNext = () => setTtStartISO(addDaysISO(startISO, +1));
                      const onToday = () => setTtStartISO(todayISO());

                      const renderChip = (t) => (
                        <span
                          key={t.id}
                          className="t-chip"
                          onDoubleClick={() => {
                            if (t.isPrivate) setPrivateModal({ open:true, item:t });
                          }}
                          title={[
                            t.operator || t.__op,
                            t.hotel,
                            `${t.pax||0} pax`,
                            t.time ? `@ ${t.time}` : "",
                            t.flight ? `Flight ${t.flight}` : ""
                          ].filter(Boolean).join(" â€¢ ")}
                        >
                          <span className={`op-pill ${operatorClass(t.operator || t.__op)}`}>{t.operator || t.__op}</span>
                          <span className="font-semibold">{t.hotel || "â€”"}</span>
                          <span className="pill">{t.pax || 0} pax</span>
                          {(t.time || t.flight) && (
                            <span className="muted">
                              {t.time ? t.time : ""}{t.time && t.flight ? " Â· " : ""}{t.flight ? t.flight : ""}
                            </span>
                          )}
                          {t.isPrivate && <span className="t-badge private">Private</span>}
                        </span>
                      );

                      const renderAreaTable = (label, entries) => (
                        <div className="transfers-wrap panel scrollbar">
                          <table>
                            <thead>
                              <tr>
                                <th className="rownum-th" style={{ position:"sticky", left:0, zIndex: 12 }}>
                                  <div className="flex items-center justify-between gap-2">
                                    <div className="font-black">{label}</div>
                                    <div className="muted text-[11px]">{startISO} â†’ {days[days.length-1]}</div>
                                  </div>
                                </th>
                                {days.map(d => (
                                  <th key={d}>
                                    <div className="t-head">
                                      <div className="t-date">{d}</div>
                                    </div>
                                  </th>
                                ))}
                              </tr>
                            </thead>
                            <tbody>
                              {entries.length === 0 ? (
                                <tr>
                                  <td className="rownum muted" style={{ position:"sticky", left:0, zIndex: 11 }}>
                                    â€” Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÎºÏÎ±Ï„Î®ÏƒÎµÎ¹Ï‚ ÏƒÏ„Î¿ Ï€Î±ÏÎ¬Î¸Ï…ÏÎ¿ â€”
                                  </td>
                                  <td colSpan={days.length}></td>
                                </tr>
                              ) : (
                                entries.map(([area, items]) => {
                                  const total = areaTotalPax(items);
                                  const maxSlots = Math.max(1, ...days.map(d => cellItems(items, d).length));

                                  return Array.from({ length: maxSlots }, (_, slotIdx) => (
                                    <tr key={area + "_slot_" + slotIdx}>
                                      {slotIdx === 0 ? (
                                        <td
                                          className="rownum"
                                          rowSpan={maxSlots}
                                          style={{ position:"sticky", left:0, zIndex: 11, background:"rgba(0,0,0,.25)" }}
                                        >
                                          <div className="flex items-center justify-between gap-2">
                                            <div className="font-black">{area}</div>
                                            <span className="pill">{total} pax</span>
                                          </div>
                                        </td>
                                      ) : null}

                                      {days.map(d => {
                                        const list = cellItems(items, d);
                                        const t = list[slotIdx];
                                        return (
                                          <td key={area + "_" + d + "_" + slotIdx}>
                                            <div className="t-cell">
                                              {t ? renderChip(t) : null}
                                            </div>
                                          </td>
                                        );
                                      })}
                                    </tr>
                                  ));
                                })
                              )}
                            </tbody>
                          </table>
                        </div>
                      );

                      const arrivalsByArea = groupByArea(byDir("ARRIVAL"));
                      const departuresByArea = groupByArea(byDir("DEPARTURE"));

                      return (
                        <>
                          <div className="panel p-2 mb-2">
                            <div className="flex flex-wrap gap-2 items-center">
                              <button className="btn rounded-xl px-3 py-1.5 text-[12px]" onClick={onPrev}>â† Î ÏÎ¿Î·Î³Î¿ÏÎ¼ÎµÎ½Î· Î·Î¼Î­ÏÎ±</button>
                              <button className="btn rounded-xl px-3 py-1.5 text-[12px]" onClick={onToday}>Î£Î®Î¼ÎµÏÎ±</button>
                              <button className="btn rounded-xl px-3 py-1.5 text-[12px]" onClick={onNext}>Î•Ï€ÏŒÎ¼ÎµÎ½Î· Î·Î¼Î­ÏÎ± â†’</button>

                              <div className="flex items-center gap-2 ml-1">
                                <input id="ttTransfersDatePick" className="input dark-date-input" type="date" defaultValue={startISO} style={{ maxWidth: 170 }} />
                                <button
                                  className="btn rounded-xl px-3 py-1.5 text-[12px]"
                                  onClick={() => {
                                    const v = document.getElementById("ttTransfersDatePick")?.value;
                                    if (v) setTtStartISO(v);
                                  }}
                                >ÎœÎµÏ„Î¬Î²Î±ÏƒÎ·</button>
                              </div>

                              <span className="pill ml-auto">{inWindow.length} ÎºÏÎ±Ï„Î®ÏƒÎµÎ¹Ï‚</span>
                            </div>
                          </div>

                          {renderAreaTable("Arrivals", arrivalsByArea)}
                          <div className="h-2"></div>
                          {renderAreaTable("Departures", departuresByArea)}
                        </>
                      );
                    })()
                  )}
                </div>

              ) : (!currentOp || !hotelsVisible) ? (
                <div className="panel p-5 text-white/75">
                  Î•Ï€Î­Î»ÎµÎ¾Îµ: <b>Tour Operator</b> â†’ Î­Î½Î±Î½ operator â†’ <b>Hotels</b>.
                </div>
              ) : (
                <>
                  {/* Toolbar */}
                  <div className="panel p-2 mb-2">
                    <div className="flex flex-wrap gap-2 items-center">
                      <div className="w-[210px]">
                        <input
                          className="cell w-full"
                          placeholder="Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ· Î¾ÎµÎ½Î¿Î´Î¿Ï‡ÎµÎ¯Î¿Ï…â€¦"
                          value={searchByOp[currentOp]}
                          onChange={(e) => setSearchByOp(prev => ({...prev, [currentOp]: e.target.value}))}
                        />
                      </div>

                      <button className="btn rounded-xl px-3 py-1.5 text-[12px]" onClick={() => excelInputRef.current?.click()}>
                        ğŸ“¥ Î•Î¹ÏƒÎ±Î³Ï‰Î³Î® Excel
                      </button>

                      <button className="btn rounded-xl px-3 py-1.5 text-[12px]" onClick={exportFile}>
                        ğŸ“¤ Î•Î¾Î±Î³Ï‰Î³Î® JSON
                      </button>

                      <button className="btn rounded-xl px-3 py-1.5 text-[12px]" onClick={clearAll}>
                        ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚
                      </button>

                      <button className="btn rounded-xl px-3 py-1.5 text-[12px]" onClick={addRow}>
                        Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Î³ÏÎ±Î¼Î¼Î®Ï‚
                      </button>

                      <button className="btn rounded-xl px-3 py-1.5 text-[12px]" onClick={addColumn}>
                        Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· ÏƒÏ„Î®Î»Î·Ï‚
                      </button>

                      <button
                        className={"btn rounded-xl px-3 py-1.5 text-[12px] " + (selectedRowByOp[currentOp]==null ? "opacity-50 cursor-not-allowed" : "")}
                        onClick={deleteSelectedRow}
                        disabled={selectedRowByOp[currentOp]==null}
                      >
                        Î”Î¹Î±Î³ÏÎ±Ï†Î® ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î·Ï‚ Î³ÏÎ±Î¼Î¼Î®Ï‚
                      </button>

                      <button
                        className={"btn rounded-xl px-3 py-1.5 text-[12px] " + (!selectedColByOp[currentOp] ? "opacity-50 cursor-not-allowed" : "")}
                        onClick={deleteSelectedCol}
                        disabled={!selectedColByOp[currentOp]}
                      >
                        Î”Î¹Î±Î³ÏÎ±Ï†Î® ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î·Ï‚ ÏƒÏ„Î®Î»Î·Ï‚
                      </button>


<input
  ref={excelInputRef}
  type="file"
  accept=".xlsx,.xls,.csv,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel"
  className="hidden"
  onChange={async (e) => {
    const f = e.target.files?.[0];
    e.target.value = "";
    try {
      await excelImport(f);
    } catch (err) {
      alert("Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î± ÎµÎ¹ÏƒÎ±Î³Ï‰Î³Î®Ï‚ Excel: " + (err?.message || "Î¬Î³Î½Ï‰ÏƒÏ„Î¿ ÏƒÏ†Î¬Î»Î¼Î±"));
    }
  }}
/>

                    </div>

                    <div className="text-[11px] muted mt-2 flex flex-wrap gap-2 items-center">
                      <span className="pill">ÎšÎ»Î¹Îº ÏƒÏ„Î¿ Î‘/Î‘ â†’ ÎµÏ€Î¹Î»Î¿Î³Î® Î³ÏÎ±Î¼Î¼Î®Ï‚</span>
                      <span className="pill">ÎšÎ»Î¹Îº ÏƒÏ„Î¿Î½ Ï„Î¯Ï„Î»Î¿ â†’ ÎµÏ€Î¹Î»Î¿Î³Î® ÏƒÏ„Î®Î»Î·Ï‚</span>
                      <span className="pill">Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ·: <b className="text-white/85">{filteredRowIndices.length}</b> / {rows.length}</span>
                    </div>
                  </div>

                  {/* Grid */}
                  <div className="grid-wrap panel scrollbar">
                    
<table>
  <colgroup>
    {cols.map((c) => (
      <col
        key={c.key}
        style={colWidths[c.key] ? { width: colWidths[c.key] + "px" } : undefined}
      />
    ))}
  </colgroup>
                      <thead>
                        <tr>
                          {cols.map((c, i) => (
                            <th
                              key={c.key}
                              data-colkey={c.key}
                              data-colkey={c.key}
                              className={"resizable " + (i===0 ? "rownum-th " : "") + (selectedColByOp[currentOp]===c.key ? " selected" : "")}
                              style={{ ...(i===0 ? {minWidth:"70px"} : {}), ...(colWidths[c.key] ? { width: colWidths[c.key] + "px" } : {}) }}
                              onClick={() => {
                                if (c.type==="auto") { setSelectedColByOp(prev => ({...prev, [currentOp]: null})); return; }
                                setSelectedColByOp(prev => ({...prev, [currentOp]: c.key}));
                                setSelectedRowByOp(prev => ({...prev, [currentOp]: null}));
                              }}
                            >
                              {c.label}
                            </th>
                          ))}
                        </tr>
                      </thead>
                      <tbody>
                        {filteredRowIndices.map((rowIndex) => (
                          <tr
                            key={rowIndex}
                            onDoubleClick={(e) => {
                              const t = e.target?.tagName?.toLowerCase();
                              if (t === "input" || t === "button" || t === "label") return;
                              openRowForm(rowIndex);
                            }}
                          >
                            {cols.map((c, i) => (
                              <td
                                key={c.key}
                                className={i===0 ? ("rownum " + (selectedRowByOp[currentOp]===rowIndex ? "selected" : "")) : ""}
                                onClick={() => {
                                  if (i!==0) return;
                                  setSelectedRowByOp(prev => ({...prev, [currentOp]: rowIndex}));
                                  setSelectedColByOp(prev => ({...prev, [currentOp]: null}));
                                }}
                              >
                                {renderCell(rowIndex, c)}
                              </td>
                            ))}
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>


{/* Row Form Modal */}
{modalOpen && (
  <div className="modal-overlay">
    <div className="modal">
      <div className="flex items-start justify-between gap-3">
        <div>
          <h2>Î¦ÏŒÏÎ¼Î± ÎºÎ±Ï„Î±Ï‡ÏÏÎ·ÏƒÎ·Ï‚</h2>
          <div className="text-[11px] muted mt-0.5">
            Î“ÏÎ±Î¼Î¼Î®: <b className="text-white/85">{(editingRowIndex ?? 0) + 1}</b>
          </div>
      <div className="flex gap-2 mt-2">
        <button
          className="modal-btn"
          type="button"
          onClick={() => modalFileInputRef.current?.click()}
        >
          Î£Ï…Î³Ï‡ÏÎ¿Î½Î¹ÏƒÎ¼ÏŒÏ‚ Î±ÏÏ‡ÎµÎ¯Î¿Ï…
        </button>
        <div className="text-[11px] mt-2">Î”Î­Ï‡ÎµÏ„Î±Î¹: <b>PDF</b> (ÏƒÏ…Î¼Î²ÏŒÎ»Î±Î¹Î±) Î® <b>JSON</b></div>
        <input
          ref={modalFileInputRef}
          type="file"
          accept="application/pdf,application/json"
          className="hidden"
          onChange={(e)=>{
            const f = e.target.files?.[0];
            if (f) handleModalImport(f);
            e.target.value = "";
          }}
        />
      </div>

        </div>
        
      </div>

      <div className="divider my-3"></div>

      <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
        {cols.filter(c => c.type !== "auto").map((c) => (
          <div key={c.key} className="panel p-3">
            <div className="text-[12px] font-semibold mb-2">{c.label}</div>

            {c.type === "check" ? (
              <label className="flex items-center gap-2 text-[12px]">
                <input
                  className="checkbox"
                  type="checkbox"
                  checked={!!draftRow?.[c.key]}
                  onChange={(e) => setDraftCell(c.key, e.target.checked)}
                />
                <span className="muted">Î•Î½ÎµÏÎ³ÏŒ</span>
              </label>
            ) : (
              <input
                className="cell w-full"
                placeholder={c.label}
                value={draftRow?.[c.key] ?? ""}
                onChange={(e) => setDraftCell(c.key, e.target.value)}
              />
            )}
          </div>
        ))}
      </div>


<div className="divider my-3"></div>

{/* Room table (mini excel) */}
<div className="panel p-3">
  <div className="flex items-center justify-between gap-2">
    <div className="text-[13px] font-extrabold">Rooming / Room Types Table</div>

    <div className="flex gap-2">
      <button className="modal-btn" type="button" onClick={roomTableAddRow}>
        Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Î³ÏÎ±Î¼Î¼Î®Ï‚
      </button>
      <button className="modal-btn" type="button" onClick={roomTableAddCol}>
        Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· ÏƒÏ„Î®Î»Î·Ï‚
      </button>
    </div>
  </div>

  <div className="muted text-[11px] mt-1">
    1Î· Î³ÏÎ±Î¼Î¼Î®: Ï„Î¯Ï„Î»Î¿Î¹ â€¢ Î‘Ï€ÏŒ ÎºÎ¬Ï„Ï‰ Î¾ÎµÎºÎ¹Î½Î¬ÎµÎ¹ Î¼Îµ 10 Î³ÏÎ±Î¼Î¼Î­Ï‚ (ÎºÎ±Î¹ Î¼Ï€Î¿ÏÎµÎ¯Ï‚ Î½Î± Ï€ÏÎ¿ÏƒÎ¸Î­ÏƒÎµÎ¹Ï‚ ÏŒÏƒÎµÏ‚ Î¸ÎµÏ‚).
  </div>

  <div className="grid-wrap panel scrollbar mt-3" style={{ maxHeight: "280px" }}>
    <table>
      <thead>
        <tr>
          {(draftRow?.roomTable?.columns || []).map((c) => (
            <th key={c.key}>{c.label}</th>
          ))}
        </tr>
      </thead>
      <tbody>
        {(draftRow?.roomTable?.rows || []).map((r, rIndex) => (
          <tr key={rIndex}>
            {(draftRow?.roomTable?.columns || []).map((c) => (
              <td key={c.key}>
                <input
                  className="cell"
                  value={r?.[c.key] ?? ""}
                  onChange={(e) => setRoomCell(rIndex, c.key, e.target.value)}
                />
              </td>
            ))}
          </tr>
        ))}
      </tbody>
    </table>
  </div>
</div>

<div className="divider my-3"></div>

<div className="modal-footer">
        <button className="modal-btn" onClick={closeRowForm}>
          Î‘ÎºÏÏÏ‰ÏƒÎ·
        </button>
        <button className="modal-btn" onClick={saveRowForm}>
          ÎšÎ±Ï„Î±Ï‡ÏÏÎ·ÏƒÎ·
        </button>
      </div>
    </div>
  </div>
)}

                </>
              )}
            </div>
          </main>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
